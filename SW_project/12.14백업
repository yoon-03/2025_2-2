import React, { useState, useEffect } from 'react';
import { 
    View, 
    Text, 
    TextInput, 
    TouchableOpacity, 
    Alert, 
    ScrollView,
    Switch,
    StyleSheet, // StyleSheetë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Import
    Platform, // í”Œë«í¼ë³„ ìŠ¤íƒ€ì¼ ì²˜ë¦¬ë¥¼ ìœ„í•´ Import
    BackHandler, // Android ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬ë¥¼ ìœ„í•´ Import
} from 'react-native';

// âš ï¸ ìŠ¤íƒ€ì¼ì€ ì´ íŒŒì¼ ë§¨ ì•„ë˜ì— í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.
// import { styles } from './styles'; // ì´ ì¤„ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.

import Icon from 'react-native-vector-icons/FontAwesome'; 
import AsyncStorage from '@react-native-async-storage/async-storage';
import MapView, { Marker, PROVIDER_GOOGLE, Region } from 'react-native-maps'; 

// --- ìƒìˆ˜ ë° ë°±ì—”ë“œ ì„¤ì • ---
const BACKEND_URL = 'http://localhost:5000';
// -----------------

// --- ğŸ“ TypeScript ì¸í„°í˜ì´ìŠ¤ ì •ì˜ ---

interface StationPosition {
    latitude: number;
    longitude: number;
}

interface Station {
    id: number;
    name: string;
    position: StationPosition;
}

interface LoginFormState {
    email: string;
    password: string;
    passwordConfirm: string;
    phone: string;
    emailPrefix: string;
    emailDomain: string;
    isTwoFactorEnabled: boolean;
}

interface MapRegion {
    latitude: number;
    longitude: number;
    latitudeDelta: number;
    longitudeDelta: number;
}

// ì˜ˆì‹œ ëŒ€ì—¬ì†Œ ë°ì´í„° (Station íƒ€ì… ì ìš©)
const stations: Station[] = [
    { id: 1, name: 'ë¯¸ì¶”í™€êµ¬ ëŒ€ì—¬ì†Œ', position: { latitude: 37.45, longitude: 126.65 } },
    { id: 2, name: 'ê°•ë‚¨ì—­ ëŒ€ì—¬ì†Œ', position: { latitude: 37.498, longitude: 127.02 } },
    { id: 3, name: 'ì‹ ë„ë¦¼ì—­ ëŒ€ì—¬ì†Œ', position: { latitude: 37.508, longitude: 126.88 } },
];

const initialRegion: MapRegion = {
    latitude: stations[0].position.latitude,
    longitude: stations[0].position.longitude,
    latitudeDelta: 0.0922,
    longitudeDelta: 0.0421,
};

// --- ğŸ’» ë©”ì¸ ì»´í¬ë„ŒíŠ¸ ---

const MapComponent: React.FC = () => {
    // ğŸ’¡ ì´ˆê¸° ë¡œë”© ìƒíƒœ ì¶”ê°€
    const [isLoading, setIsLoading] = useState(true); 
    const [mapRegion, setMapRegion] = useState<MapRegion>(initialRegion);
    const [activeTab, setActiveTab] = useState<string>('map');
    const [favorites, setFavorites] = useState<Station[]>([]);
    const [userToken, setUserToken] = useState<string | null>(null);
    const [userInfo, setUserInfo] = useState<{ email: string } | null>(null); 
    const isLoggedIn: boolean = !!userToken;
    
    const [isSignup, setIsSignup] = useState<boolean>(false); 
    const [loginForm, setLoginForm] = useState<LoginFormState>({ 
        email: '',
        password: '',
        passwordConfirm: '',
        phone: '',
        emailPrefix: '',
        emailDomain: 'gmail.com',
        isTwoFactorEnabled: false
    });
    const [authError, setAuthError] = useState<string>('');

    // 1. ì´ˆê¸° ë¡œë”© (AsyncStorage ë¡œë“œ ë° ìŠ¤í”Œë˜ì‹œ í™”ë©´ ì²˜ë¦¬)
    useEffect(() => {
        const initializeApp = async () => {
            // AsyncStorage ë¡œë“œ
            const token = await AsyncStorage.getItem('userToken');
            setUserToken(token);
            
            // ğŸ’¡ ìŠ¤í”Œë˜ì‹œ í™”ë©´ì„ ìœ„í•œ 2ì´ˆ ì§€ì—° (Resolve íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì • ë°˜ì˜)
            await new Promise<void>(resolve => {
                setTimeout(() => {
                    resolve(); 
                }, 2000); 
            });

            setIsLoading(false);
        };
        initializeApp();
    }, []);
    
    // 2. í† í° ë³€ê²½ ê°ì§€ (UserInfo ë° Favorites ë¡œë“œ)
    useEffect(() => {
        if (userToken) {
            fetchUserInfo();
            fetchFavorites();
        } else {
            setUserInfo(null);
            setFavorites([]);
        }
    }, [userToken]);

    // 3. Android ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬ (ì¢…ë£Œ í™•ì¸ ë° íƒ­ ë³µê·€)
    useEffect(() => {
        const backAction = () => {
            // 'map' íƒ­ì¼ ë•Œ ì¢…ë£Œ í™•ì¸ íŒì—…
            if (activeTab === 'map') {
                Alert.alert(
                    "ì•± ì¢…ë£Œ",
                    "ì •ë§ë¡œ ì•±ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    [
                        { text: "ì·¨ì†Œ", onPress: () => null, style: "cancel" },
                        { text: "ì¢…ë£Œ", onPress: () => BackHandler.exitApp() }
                    ],
                    { cancelable: false }
                );
                return true; // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì•± ì¢…ë£Œ)
            } 
            
            // ë‹¤ë¥¸ íƒ­ì¼ ë•Œ 'map' íƒ­ìœ¼ë¡œ ë³µê·€
            if (activeTab !== 'map') {
                setActiveTab('map');
                return true; // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (íƒ­ ë³µê·€)
            }

            return false; // ê·¸ ì™¸ ìƒí™© (ì²˜ë¦¬í•  ê²ƒì´ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ ë™ì‘ í—ˆìš©)
        };

        const backHandler = BackHandler.addEventListener(
            "hardwareBackPress",
            backAction
        );

        return () => backHandler.remove();
    }, [activeTab]);

    // --- (ì´í•˜ API & Auth FunctionsëŠ” ë³€ê²½ ì—†ìŒ) ---
    const handleSetToken = async (token: string) => {
        await AsyncStorage.setItem('userToken', token);
        setUserToken(token);
    };

    const handleRemoveToken = async () => {
        await AsyncStorage.removeItem('userToken');
        setUserToken(null);
        setUserInfo(null);
    };

    const fetchUserInfo = async () => {
        try {
            const response = await fetch(`${BACKEND_URL}/api/user`, {
                headers: { 'Authorization': `Bearer ${userToken}` },
            });
            if (response.ok) {
                const data = await response.json();
                setUserInfo(data);
            } else {
                handleLogout(); 
            }
        } catch (error) {
            console.error('Failed to fetch user info:', error);
            handleLogout();
        }
    };

    const fetchFavorites = async () => {
        if (!userToken) return;
        try {
            const response = await fetch(`${BACKEND_URL}/api/favorites`, {
                headers: { 'Authorization': `Bearer ${userToken}` },
            });
            if (response.ok) {
                const data = await response.json();
                const formattedFavorites: Station[] = data.map((fav: any) => ({
                    id: fav.id, // IDê°€ ìˆë‹¤ê³  ê°€ì •
                    name: fav.station_name, 
                    position: { latitude: fav.latitude, longitude: fav.longitude }
                }));
                setFavorites(formattedFavorites);
            } else if (response.status !== 401) {
                console.error('Failed to fetch favorites');
            }
        } catch (error) {
            console.error('Fetch Favorites Error:', error);
        }
    };

    const handleAuth = async (isSignupMode: boolean) => {
        setAuthError('');
        const endpoint = isSignupMode ? '/api/auth/signup' : '/api/auth/login';
        
        let payload: any = {}; 

        if (isSignupMode) {
            if (loginForm.password.length < 6) { return setAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); }
            if (loginForm.password !== loginForm.passwordConfirm) { return setAuthError('ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
            const finalEmail = `${loginForm.emailPrefix}@${loginForm.emailDomain}`;
            if (!loginForm.emailPrefix || !loginForm.emailDomain || !finalEmail.includes('@')) { return setAuthError('ì´ë©”ì¼ ì•„ì´ë””ì™€ ë„ë©”ì¸ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
            const phoneRegex = /^\d{10,11}$/;
            if (!phoneRegex.test(loginForm.phone)) { return setAuthError('ìœ íš¨í•œ í•¸ë“œí° ë²ˆí˜¸(10~11ìë¦¬ ìˆ«ì)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }

            payload = {
                email: finalEmail,
                password: loginForm.password,
                phone: loginForm.phone,
                isTwoFactorEnabled: loginForm.isTwoFactorEnabled,
            };
        } else {
            payload = {
                email: loginForm.email, 
                password: loginForm.password
            }
        }

        try {
            const response = await fetch(BACKEND_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload), 
            });

            const data = await response.json();

            if (response.ok) {
                await handleSetToken(data.token);
                const initialFormState: LoginFormState = { email: '', password: '', passwordConfirm: '', phone: '', emailPrefix: '', emailDomain: 'gmail.com', isTwoFactorEnabled: false }; 
                setLoginForm(initialFormState);
                setIsSignup(false);
                setAuthError(isSignupMode ? 'íšŒì›ê°€ì… ì„±ê³µ!' : 'ë¡œê·¸ì¸ ì„±ê³µ!');
                Alert.alert(isSignupMode ? 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                setAuthError(data.error || 'ì¸ì¦ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('Network or API Error:', error);
            setAuthError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Node.js ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }
    };
    
    const handleLogout = async () => {
        await handleRemoveToken();
        setAuthError('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        Alert.alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    const handleAuthRedirect = () => {
        setAuthError('ëŒ€ì—¬ ë° ë°˜ë‚©ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        setActiveTab('my');
    };

    const handleInputChange = (name: keyof LoginFormState, value: string) => {
        setLoginForm(prevForm => ({ 
            ...prevForm,
            [name]: value 
        }));
        setAuthError('');
    };

    const handleSwitchChange = (name: keyof LoginFormState, value: boolean) => {
        setLoginForm(prevForm => ({
            ...prevForm,
            [name]: value
        }));
        setAuthError('');
    }
    
    const handleAddFavorite = async (station: Station) => {
        if (!isLoggedIn) {
            Alert.alert("ì¦ê²¨ì°¾ê¸° ì¶”ê°€", "ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
        }
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/favorites`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({
                    stationName: station.name,
                    position: [station.position.latitude, station.position.longitude] 
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                Alert.alert("ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì„±ê³µ", data.message);
                fetchFavorites();
            } else {
                Alert.alert("ì¶”ê°€ ì‹¤íŒ¨", data.error);
            }
        } catch (error) {
            Alert.alert("ì„œë²„ ì˜¤ë¥˜", "ì„œë²„ ì—°ê²° ì˜¤ë¥˜ë¡œ ì¦ê²¨ì°¾ê¸°ë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    };

    const handleGoToFavorite = (position: StationPosition) => {
        setMapRegion({ ...mapRegion, latitude: position.latitude, longitude: position.longitude }); 
        setActiveTab('map'); 
    };
    
    const handleTabToggle = (tabName: string) => {
        if (activeTab === tabName) {
            setActiveTab('map');
        } else {
            setActiveTab(tabName);
        }
    };
    
    const handleCenterButtonClick = () => {
        if (activeTab === 'map') {
            if (isLoggedIn) {
                setActiveTab('rental');
            } else {
                handleAuthRedirect();
            }
        } else {
            setActiveTab('map');
        }
    };

    // --- Sub-Components (TSX) ---
    const EmailInputFields: React.FC = () => (
        <View style={styles.emailSplitContainer}>
            <TextInput
                placeholder="ì•„ì´ë””"
                value={loginForm.emailPrefix}
                onChangeText={(text) => handleInputChange('emailPrefix', text)}
                style={[styles.loginInput, { width: '45%', marginRight: 10 }]}
            />
            <Text style={{ marginRight: 10, color: '#555' }}>@</Text>
            <TextInput
                placeholder="gmail.com"
                value={loginForm.emailDomain}
                onChangeText={(text) => handleInputChange('emailDomain', text)}
                style={[styles.loginInput, { width: '45%' }]}
            />
        </View>
    );
    
    // --- ë Œë”ë§ í•¨ìˆ˜ ---
    
    const renderHeader = () => {
        if (activeTab === 'map' || activeTab === 'rental') {
            return (
                <View style={styles.header}>
                    <View style={styles.searchBar}>
                        <Text style={styles.rentalNumber}>ëŒ€ì—¬ì†Œ ë²ˆí˜¸</Text>
                        <TextInput 
                            placeholder="ì›í•˜ì‹œëŠ” ì§€ì—­ì´ ì–´ë””ì‹ ê°€ìš”?" 
                            style={styles.searchInput}
                        />
                    </View>
                </View>
            );
        }
        return null;
    };

    const renderMapTab = () => (
        <View style={styles.map}>
            <MapView
                provider={PROVIDER_GOOGLE}
                style={styles.mapView} 
                region={mapRegion}
                onRegionChangeComplete={setMapRegion} 
            >
                {stations.map(station => (
                    <Marker
                        key={station.id}
                        coordinate={station.position}
                        title={station.name}
                        onPress={() => Alert.alert('ëŒ€ì—¬ì†Œ ì •ë³´', station.name)}
                    />
                ))}
            </MapView>
        </View>
    );

    const renderRentalTab = () => (
        <ScrollView style={styles.rentalPage} contentContainerStyle={{flexGrow: 1}}>
            <Text style={styles.pageTitle}>ìš°ì‚° ëŒ€ì—¬/ë°˜ë‚©</Text>
            
            <TouchableOpacity style={[styles.actionButton, styles.primaryButton]} onPress={() => Alert.alert("QRì½”ë“œ ìŠ¤ìº”", "QRì½”ë“œ ìŠ¤ìº” ê¸°ëŠ¥ ì‹¤í–‰ (ëª©ì—…)")}>
                <View style={{flexDirection: 'row', alignItems: 'center'}}>
                    <Icon name="qrcode" size={20} color="#fff" style={{marginRight: 10}} /> 
                    <Text style={styles.primaryButtonText}>ìš°ì‚° ëŒ€ì—¬ (QR ìŠ¤ìº”)</Text>
                </View>
            </TouchableOpacity>
            
            <TouchableOpacity style={[styles.actionButton, styles.secondaryButton, {marginTop: 15}]} onPress={() => Alert.alert("ë°˜ë‚© ì²˜ë¦¬", "ë°˜ë‚© ì²˜ë¦¬ ê¸°ëŠ¥ ì‹¤í–‰ (ëª©ì—…)")}>
                <Text style={styles.secondaryButtonText}>ìš°ì‚° ë°˜ë‚©</Text>
            </TouchableOpacity>
            
            {isLoggedIn && (
                <View style={styles.rentalStatusBox}>
                    <Text style={styles.statusTitle}>ëŒ€ì—¬ í˜„í™©</Text>
                    <Text>í˜„ì¬ ëŒ€ì—¬ ì¤‘ì¸ ìš°ì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</Text>
                    <Text style={styles.statusFooter}>ë¡œê·¸ì¸ ìƒíƒœ: <Text style={{fontWeight: 'bold', color: '#38b438'}}>{userInfo?.email || 'ì•Œ ìˆ˜ ì—†ìŒ'}</Text></Text>
                </View>
            )}
        </ScrollView>
    );

    const renderMyTab = () => (
        <ScrollView style={styles.myPage} contentContainerStyle={{flexGrow: 1}}>
            <Text style={styles.pageTitle}>ë§ˆì´ í˜ì´ì§€</Text>
            
            <TouchableOpacity style={styles.myListItem} onPress={isLoggedIn ? handleLogout : () => setIsSignup(!isSignup)}>
                <Icon name="user" size={20} color="#38b438" style={styles.myIcon}/>
                <Text>{isLoggedIn ? 'ë¡œê·¸ì•„ì›ƒ' : (isSignup ? 'ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'ë¡œê·¸ì¸ / íšŒì›ê°€ì…')}</Text>
            </TouchableOpacity>

            {isLoggedIn ? (
                <View style={[styles.loginStatusBox, styles.loggedInStatus]}>
                    <Text>í™˜ì˜í•©ë‹ˆë‹¤!</Text>
                    <Text>í˜„ì¬ ì‚¬ìš©ì: <Text style={{fontWeight: 'bold', color: '#38b438'}}>{userInfo?.email || 'ì•Œ ìˆ˜ ì—†ìŒ'}</Text></Text>
                    <TouchableOpacity style={[styles.actionButton, styles.secondaryButton]} onPress={handleLogout}>
                        <Text style={styles.secondaryButtonText}>ë¡œê·¸ì•„ì›ƒ</Text>
                    </TouchableOpacity>
                </View>
            ) : (
                <View style={styles.loginFormContainer}>
                    <Text style={styles.formTitle}>{isSignup ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</Text>
                    {authError && <Text style={styles.authError}>{authError}</Text>}
                    
                    {isSignup ? (
                        <View>
                            <EmailInputFields/>
                            <TextInput 
                                secureTextEntry
                                placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" 
                                value={loginForm.password} 
                                onChangeText={(text) => handleInputChange('password', text)} 
                                style={styles.loginInput} 
                            />
                            <TextInput 
                                secureTextEntry
                                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" 
                                value={loginForm.passwordConfirm} 
                                onChangeText={(text) => handleInputChange('passwordConfirm', text)} 
                                style={styles.loginInput} 
                            />
                            <TextInput 
                                keyboardType="numeric"
                                placeholder="í•¸ë“œí° ë²ˆí˜¸(ìˆ«ìë§Œ ì…ë ¥)" 
                                value={loginForm.phone} 
                                onChangeText={(text) => handleInputChange('phone', text)} 
                                style={styles.loginInput} 
                            />
                            <View style={styles.twoFactorCheck}>
                                <Switch
                                    onValueChange={(value) => handleSwitchChange('isTwoFactorEnabled', value)}
                                    value={loginForm.isTwoFactorEnabled}
                                />
                                <Text style={{marginLeft: 10}}>2ë‹¨ê³„ ì¸ì¦ í™œì„±í™”</Text>
                            </View>
                        </View>
                    ) : (
                        <View>
                            <TextInput 
                                keyboardType="email-address"
                                placeholder="ì´ë©”ì¼" 
                                value={loginForm.email} 
                                onChangeText={(text) => handleInputChange('email', text)} 
                                style={styles.loginInput} 
                            />
                            <TextInput 
                                secureTextEntry
                                placeholder="ë¹„ë°€ë²ˆí˜¸" 
                                value={loginForm.password} 
                                onChangeText={(text) => handleInputChange('password', text)} 
                                style={styles.loginInput} 
                            />
                        </View>
                    )}

                    <TouchableOpacity style={[styles.actionButton, styles.primaryButton]} onPress={() => handleAuth(isSignup)}>
                        <Text style={styles.primaryButtonText}>{isSignup ? 'íšŒì›ê°€ì… ì™„ë£Œ' : 'ë¡œê·¸ì¸'}</Text>
                    </TouchableOpacity>
                    
                    <TouchableOpacity style={[styles.actionButton, styles.secondaryButton, {marginTop: 10}]} onPress={() => setIsSignup(!isSignup)}>
                        <Text style={styles.secondaryButtonText}>{isSignup ? 'ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ' : 'íšŒì›ê°€ì…'}</Text>
                    </TouchableOpacity>
                    
                    <View style={{marginTop: 20}}>
                        <TouchableOpacity style={[styles.actionButton, styles.socialGoogleButton]} onPress={() => Alert.alert("ì†Œì…œ ë¡œê·¸ì¸", "Google ì—°ë™ ëª©ì—…")}>
                            <Icon name="google" size={18} color="white" style={{marginRight: 8}} />
                            <Text style={styles.primaryButtonText}>Google (UI ëª©ì—…)</Text>
                        </TouchableOpacity>
                    </View>
                </View>
            )}
            <Text style={styles.footerNote}>* í˜„ì¬ Node.js ì„œë²„(5000í¬íŠ¸)ì™€ ì—°ë™ë©ë‹ˆë‹¤.</Text>
        </ScrollView>
    );

    const renderFavoritesTab = () => (
        <ScrollView style={styles.favoritesPage} contentContainerStyle={{flexGrow: 1}}>
            <View style={styles.favoritesHeader}>
                <Text style={styles.favoritesTitle}>ì¦ê²¨ì°¾ê¸° ëª©ë¡ ({isLoggedIn ? 'DB ì—°ë™' : 'ë¡œê·¸ì¸ í•„ìš”'})</Text>
                <TouchableOpacity style={styles.newList} onPress={() => Alert.alert("ë¦¬ìŠ¤íŠ¸", "ìƒˆ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸° ëª©ì—…")}>
                    <Icon name="plus" size={14} color="#38b438" />
                    <Text style={{color: '#38b438', marginLeft: 5}}>ìƒˆ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°</Text>
                </TouchableOpacity>
            </View>
            <View style={styles.favoritesListContainer}>
                {favorites.length > 0 ? (
                    favorites.map((fav, index) => (
                        <TouchableOpacity key={index} style={styles.favoriteItem} onPress={() => handleGoToFavorite(fav.position)}>
                            <View style={styles.itemIconWrapper}>
                                <Icon name="star" size={18} color="#ffc107" style={styles.itemIcon}/>
                            </View>
                            <View style={styles.itemDetails}>
                                <Text style={styles.itemName}>{fav.name}</Text>
                                <View style={styles.itemSubInfo}>
                                    <Icon name="lock" size={10} color="#999" style={{marginRight: 5}}/>
                                    <Text style={{fontSize: 12, color: '#999'}}>ë¹„ê³µê°œ</Text>
                                </View>
                            </View>
                        </TouchableOpacity>
                    ))
                ) : (
                    <Text>{isLoggedIn ? 'í˜„ì¬ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì¦ê²¨ì°¾ê¸° ëª©ë¡ì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.'}</Text>
                )}
            </View>
        </ScrollView>
    );
    
    // ğŸ’¡ ë¡œë”© ì¤‘ì¼ ë•Œ ìŠ¤í”Œë˜ì‹œ í™”ë©´ ë Œë”ë§
    if (isLoading) {
        return (
            <View style={styles.splashContainer}>
                <Text style={styles.splashText}>ìš°ì‚° ê³µìœ  ì„œë¹„ìŠ¤</Text>
                {/* <ActivityIndicator size="large" color="#fff" style={{marginTop: 20}} /> */}
            </View>
        );
    }
    
    return (
        <View style={styles.mapContainer}>
            {renderHeader()}

            <View style={styles.contentArea}>
                {activeTab === 'map' && renderMapTab()}
                {activeTab === 'rental' && renderRentalTab()}
                {activeTab === 'my' && renderMyTab()}
                {activeTab === 'favorites' && renderFavoritesTab()}
            </View>

            <View style={styles.footer}>
                {activeTab === 'map' && (
                    <View style={styles.timeDisplayWrapper}>
                        <Text style={styles.timeDisplay}>12 min</Text>
                    </View>
                )}
                
                <View style={styles.navButtons}>
                    <TouchableOpacity style={styles.navButton} onPress={() => handleTabToggle('my')}>
                        <Text style={styles.navButtonText}>MY</Text>
                    </TouchableOpacity>
                    
                    <View style={styles.navPlaceholder} /> 
                    
                    <TouchableOpacity style={styles.navButton} onPress={() => handleTabToggle('favorites')}>
                        <Text style={styles.navButtonText}>ì¦ê²¨ì°¾ê¸°</Text>
                    </TouchableOpacity>
                </View>
            </View>
            
            <View style={styles.centerButtonWrapper}>
                <TouchableOpacity 
                    style={styles.centerRoundButton} 
                    onPress={handleCenterButtonClick}
                >
                    {activeTab === 'map' ? (
                        <Icon name="qrcode" size={32} color="#fff" />
                    ) : (
                        <Icon name="home" size={32} color="#fff" />
                    )}
                </TouchableOpacity>
            </View>
        </View>
    );
};

// -----------------------------------------------------------
// ğŸŒŸ í†µí•©ëœ ìŠ¤íƒ€ì¼ ì •ì˜ ğŸŒŸ
// -----------------------------------------------------------
const styles = StyleSheet.create({
    // Splash Screen ìŠ¤íƒ€ì¼
    splashContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: '#38b438', 
    },
    splashText: {
        fontSize: 30,
        fontWeight: 'bold',
        color: '#fff',
    },
    
    // 1. ì „ì²´ ë ˆì´ì•„ì›ƒ ê¸°ë³¸ ì„¤ì •
    mapContainer: {
        flex: 1, 
        backgroundColor: '#fff',
    },
    contentArea: {
        flex: 1, 
    },
    
    // 2. MapView ë° ì§€ë„ ì˜ì—­ ìŠ¤íƒ€ì¼
    map: {
        flex: 1, 
    },
    mapView: {
        flex: 1, 
    },
    
    // 3. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (footer) ìŠ¤íƒ€ì¼
    footer: {
        backgroundColor: '#fff',
        borderTopWidth: 1,
        borderTopColor: '#eee',
        paddingBottom: Platform.OS === 'ios' ? 20 : 0, 
    },
    navButtons: {
        flexDirection: 'row',
        justifyContent: 'space-around',
        alignItems: 'center',
        height: 60,
        paddingHorizontal: 20,
    },
    navButton: {
        flex: 1, 
        alignItems: 'center',
        justifyContent: 'center',
    },
    navButtonText: {
        color: '#555',
        fontSize: 14,
    },
    navPlaceholder: {
        width: 80, 
        height: '100%',
    },

    // 4. ì¤‘ì•™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (footer ìœ„ì— ê²¹ì³ì„œ ë°°ì¹˜)
    centerButtonWrapper: {
        position: 'absolute',
        bottom: 30, 
        left: '50%',
        marginLeft: -35, 
        zIndex: 10,
    },
    centerRoundButton: {
        width: 70,
        height: 70,
        borderRadius: 35,
        backgroundColor: '#38b438',
        justifyContent: 'center',
        alignItems: 'center',
        ...Platform.select({
            ios: {
                shadowColor: '#000',
                shadowOffset: { width: 0, height: 2 },
                shadowOpacity: 0.25,
                shadowRadius: 3.84,
            },
            android: {
                elevation: 5,
            },
        }),
    },
    timeDisplayWrapper: {
        position: 'absolute',
        top: -40,
        alignSelf: 'center',
        backgroundColor: '#38b438',
        borderRadius: 15,
        paddingHorizontal: 15,
        paddingVertical: 5,
    },
    timeDisplay: {
        color: '#fff',
        fontWeight: 'bold',
        fontSize: 14,
    },

    // 5. ê¸°íƒ€ ìŠ¤íƒ€ì¼ (í—¤ë”, ë Œíƒˆ, ë¡œê·¸ì¸, ì¦ê²¨ì°¾ê¸° ë“±)
    header: {
        paddingTop: Platform.OS === 'ios' ? 40 : 15, 
        paddingHorizontal: 15, 
        paddingBottom: 10,
        backgroundColor: '#fff',
        borderBottomWidth: 1,
        borderBottomColor: '#eee',
    },
    searchBar: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    rentalNumber: {
        marginRight: 10,
        fontWeight: 'bold',
        color: '#555',
    },
    searchInput: {
        flex: 1,
        borderBottomWidth: 1,
        borderBottomColor: '#ccc',
        paddingVertical: 5,
        paddingHorizontal: 5,
    },
    
    // ë Œíƒˆ/ë§ˆì´í˜ì´ì§€/ì¦ê²¨ì°¾ê¸° ê´€ë ¨ ìŠ¤íƒ€ì¼
    rentalPage: { flex: 1, padding: 20 },
    myPage: { flex: 1, padding: 20 },
    favoritesPage: { flex: 1, padding: 20 },
    pageTitle: { fontSize: 24, fontWeight: 'bold', marginBottom: 20 },
    actionButton: { padding: 15, borderRadius: 8, alignItems: 'center' },
    primaryButton: { backgroundColor: '#38b438' },
    secondaryButton: { borderWidth: 1, borderColor: '#38b438' },
    primaryButtonText: { color: '#fff', fontWeight: 'bold' },
    secondaryButtonText: { color: '#38b438', fontWeight: 'bold' },
    
    // ë¡œê·¸ì¸/íšŒì›ê°€ì… í¼ ìŠ¤íƒ€ì¼
    loginFormContainer: { marginVertical: 15, padding: 15, borderWidth: 1, borderColor: '#eee', borderRadius: 8 },
    formTitle: { fontSize: 18, fontWeight: 'bold', marginBottom: 10, color: '#38b438' },
    authError: { color: 'red', marginBottom: 10, textAlign: 'center' },
    loginInput: { borderWidth: 1, borderColor: '#ccc', padding: 10, borderRadius: 5, marginBottom: 10 },
    emailSplitContainer: { flexDirection: 'row', alignItems: 'center', marginBottom: 10 },
    twoFactorCheck: { flexDirection: 'row', alignItems: 'center', marginBottom: 15 },
    
    // ë§ˆì´í˜ì´ì§€ ëª©ë¡
    myListItem: { flexDirection: 'row', alignItems: 'center', paddingVertical: 15, borderBottomWidth: 1, borderBottomColor: '#eee' },
    myIcon: { marginRight: 10 },
    loginStatusBox: { padding: 15, backgroundColor: '#f9f9f9', borderRadius: 8, marginTop: 15, alignItems: 'center' },
    loggedInStatus: { borderColor: '#38b438', borderWidth: 1 },
    footerNote: { marginTop: 30, fontSize: 12, color: '#999', textAlign: 'center' },

    // ë Œíƒˆ ìƒíƒœ ë°•ìŠ¤
    rentalStatusBox: { 
        padding: 15, 
        backgroundColor: '#e6ffe6',
        borderRadius: 8, 
        marginTop: 20, 
        borderWidth: 1,
        borderColor: '#38b438'
    },
    statusTitle: { 
        fontSize: 16, 
        fontWeight: 'bold', 
        marginBottom: 5,
        color: '#38b438'
    },
    statusFooter: { 
        marginTop: 10, 
        fontSize: 12, 
        color: '#777' 
    },

    // ì¦ê²¨ì°¾ê¸° ìŠ¤íƒ€ì¼
    favoritesHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 },
    favoritesTitle: { fontSize: 18, fontWeight: 'bold' },
    newList: { flexDirection: 'row', alignItems: 'center' },
    favoritesListContainer: { marginTop: 10 },
    favoriteItem: { flexDirection: 'row', alignItems: 'center', paddingVertical: 10, borderBottomWidth: 1, borderBottomColor: '#f0f0f0' },
    itemIconWrapper: { width: 30, alignItems: 'center' },
    itemDetails: { flex: 1, marginLeft: 10 },
    itemName: { fontSize: 16 },
    itemSubInfo: { flexDirection: 'row', marginTop: 3 },
    
    // ì•„ì´ì½˜ ê´€ë ¨ ìŠ¤íƒ€ì¼
    itemIcon: {},
    socialGoogleButton: { backgroundColor: '#db4437' },
});


export default MapComponent;
