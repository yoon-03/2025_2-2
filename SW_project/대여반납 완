import React, { useState, useEffect, useCallback} from 'react';
import './App.css'; 
import { MapContainer, TileLayer, Marker, Popup, useMap} from 'react-leaflet';
import 'leaflet/dist/leaflet.css'; 
import L from 'leaflet';
import icon from 'leaflet/dist/images/marker-icon.png';
import iconShadow from 'leaflet/dist/images/marker-shadow.png';

import { FaStar, FaLock, FaUser, FaGoogle, FaHome, FaQrcode, FaCheck, FaMinusCircle} from 'react-icons/fa'; 

// --- ë°±ì—”ë“œ ì„¤ì • ---
const BACKEND_URL = 'http://localhost:4000';
// -----------------
// ëŒ€ì—¬ì†Œ ê±°ë¦¬ ê³„ì‚°ì„ ìœ„í•œ ìƒìˆ˜ ì •ì˜
const EARTH_RADIUS_KM = 6371;

// ë‘ ìœ„ë„/ê²½ë„ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
const getDistance = (lat1, lon1, lat2, lon2) => {
    const toRad = (value) => (value * Math.PI) / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    
    const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    
    return EARTH_RADIUS_KM * c; // ê²°ê³¼ëŠ” km
};

let DefaultIcon = L.icon({
  iconUrl: icon,
  shadowUrl: iconShadow,
});
L.Marker.prototype.options.icon = DefaultIcon;

//ëŒ€ì—¬ì†Œ ì¡°íšŒë¥¼ ìœ„í•œ ì»´í¬ë„ŒíŠ¸
function MapSearchCenterer({ position }) {
    const map = useMap();
    useEffect(() => {
        if (position) {
            // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ì˜ ì¤‘ì‹¬ì„ ì´ë™í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ì ìš© (Zoom: 17)
            map.flyTo(position, 17); 
        }
    }, [position, map]);
    return null;
}

const MapComponent = () => {
  // ì§€ë„ ë° íƒ­ ìƒíƒœ
  const [stations, setStations] = useState([]);
  // const [loading, setLoading] = useState(true);
  const [mapCenter, setMapCenter] = useState([37.4481, 126.657]); //ì´ˆê¸° ì§€ë„ ì¸í•˜ê³µì „ìœ¼ë¡œ
  const [activeTab, setActiveTab] = useState('map');
  const [favorites, setFavorites] = useState([]);
  //ëŒ€ì—¬ì†Œ ì¡°íšŒë¥¼ ìœ„í•´ ì¶”ê°€
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState([]);
    // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ ì´ë™ì‹œí‚¤ê¸° ìœ„í•´ ì¶”ê°€
  const [centerPosition, setCenterPosition] = useState(null);
  //ì¦ê²¨ì°¾ê¸° ì‚­ì œë¥¼ ìœ„í•´ ì¶”ê°€
  const [isDeleteMode, setIsDeleteMode] = useState(false);
  //ìœ ì € ìœ„ì¹˜ ì •ë³´ë¥¼ ìœ„í•´ ì¶”ê°€
  const [userLocation, setUserLocation] = useState(null);
  //ê·¼ì²˜ ëŒ€ì—¬ì†Œ í‘œì‹œë¥¼ ìœ„í•´ ì¶”ê°€
  const [nearbyStations, setNearbyStations] = useState([]);
  // --- JWT ì¸ì¦ ìƒíƒœ ---
  const [userToken, setUserToken] = useState(localStorage.getItem('userToken'));
  const [userInfo, setUserInfo] = useState(null); 
  const isLoggedIn = !!userToken;

 // ëŒ€ì—¬ì†Œ ìƒì„¸ ë° ëŒ€ì—¬ ìƒíƒœ ê´€ë¦¬
  const [selectedStationId, setSelectedStationId] = useState(null); // ëª©ë¡ì„ ë³´ì—¬ì¤„ ëŒ€ì—¬ì†Œ ID
  const [currentRentedUmbrellaId, setCurrentRentedUmbrellaId] = useState(null); // í˜„ì¬ ëŒ€ì—¬ ì¤‘ì¸ ìš°ì‚° ID
  const isReturnMode = !!currentRentedUmbrellaId; 
  const [availableUmbrella, setAvailableUmbrella] = useState([]); // ëŒ€ì—¬ì†Œë³„ ê°€ìš© ìš°ì‚° ëª©ë¡

    // âœ… ê·¼ì²˜ ëŒ€ì—¬ì†Œ ê²€ìƒ‰ í™œì„±í™” ìƒíƒœ ì¶”ê°€ (ë²„íŠ¼ í† ê¸€ìš©)
  const [isNearbySearchActive, setIsNearbySearchActive] = useState(false); 
  const SEARCH_RADIUS = 2; // km

  const toggleDeleteMode = () => {
    setIsDeleteMode(prev => !prev);
};
//ì¦ê²¨ì°¾ê¸° ì‚­ì œ
const handleRemoveFavorite = async (station) => {
    const stationId = station.station_id; 

    if (!isLoggedIn) {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
    }
    
    // station.nameì€ ì—†ìœ¼ë©´ station.station_idë¥¼ ëŒ€ì‹  ì‚¬ìš©
    if (!window.confirm(`[${station.name || stationId}]ì„(ë¥¼) ì •ë§ë¡œ ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        // âœ… ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ stationId ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­
        const res = await fetch(`${BACKEND_URL}/api/favorites?station_id=${stationId}`, {
            method: "DELETE",
            headers: {
                Authorization: `Bearer ${userToken}`,
            },
        });

        if (res.ok) {
            alert("ì¦ê²¨ì°¾ê¸° ì‚­ì œ ì™„ë£Œ!");
            // ì‚­ì œ í›„ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
            fetchFavorites(); 
        } else {
            const data = await res.json();
            alert(data.error || "ì‚­ì œ ì‹¤íŒ¨");
        }
    } catch (error) {
        console.error('Favorite remove error:', error);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
    }
};
//ê·¼ì²˜ ëŒ€ì—¬ì†Œ ê²€ìƒ‰ í† ê¸€ í•¸ë“¤ëŸ¬
const handleNearbySearch = () => {
    // 1. ìƒíƒœ í† ê¸€
    const newState = !isNearbySearchActive;
    setIsNearbySearchActive(newState);

    // 2. ê²€ìƒ‰ í™œì„±í™” ì‹œ (ìƒˆë¡œ ì¼œëŠ” ê²½ìš°) í˜„ì¬ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ ìµœì‹  ìœ„ì¹˜ë¥¼ í™•ë³´
    if (newState) {
        getCurrentLocation(); // getCurrentLocation í•¨ìˆ˜ëŠ” ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        setActiveTab('map'); // ì§€ë„ë¡œ ì´ë™
    } else {
        // ê²€ìƒ‰ ì¢…ë£Œ ì‹œ ëª©ë¡ ì´ˆê¸°í™”
        setNearbyStations([]);
    }
};

  
  // ì¸ì¦ í¼ ìƒíƒœ
  const [isSignup, setIsSignup] = useState(false); 
  const [loginForm, setLoginForm] = useState({ 
    email: '',
    password: '',
    nickname: '',
    passwordConfirm: '',
    phonenumber: '',
    emailPrefix: '',
    emailDomain: 'gmail.com',
    isTwoFactorEnabled: false
  });
  const [authError, setAuthError] = useState('');
  
 const handleLogout = useCallback(() => {
    localStorage.removeItem('userToken');
    setUserToken(null);
    setUserInfo(null);
    setCurrentRentedUmbrellaId(null); 
    setAuthError('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
    alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
}, [setUserToken, setUserInfo, setAuthError, setCurrentRentedUmbrellaId]);


  const handleAuthRedirect = () => {
  setAuthError('ëŒ€ì—¬ ë° ë°˜ë‚©ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  setActiveTab('my');
  };

  // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const fetchUserInfo = useCallback(async () => {
    try {
        const response = await fetch(`${BACKEND_URL}/api/user`, {
            headers: { 'Authorization': `Bearer ${userToken}` },
        });
        if (response.ok) {
            const data = await response.json();
            setUserInfo(data);
            setCurrentRentedUmbrellaId(data.current_rental_id || null);
        } else {
            handleLogout(); // ğŸ‘ˆ useCallbackìœ¼ë¡œ ê°ì‹¸ì§„ handleLogout í˜¸ì¶œ
        }
    } catch (error) {
        console.error('Failed to fetch user info:', error);
        handleLogout(); // ğŸ‘ˆ useCallbackìœ¼ë¡œ ê°ì‹¸ì§„ handleLogout í˜¸ì¶œ
    }
}, [userToken, handleLogout]);

  // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const fetchFavorites = useCallback(async () => {
    try {
        const res = await fetch(`${BACKEND_URL}/api/favorites`, {
            headers: { Authorization: `Bearer ${userToken}` },
        });

        const data = await res.json();
        
        // ğŸš¨ âœ… ìˆ˜ì •: ë°±ì—”ë“œì—ì„œ ë°›ì€ í‚¤ ì´ë¦„(station_id, station_name ë“±)ì„ ì •í™•íˆ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const formattedFavorites = data.map(fav => ({
            station_id: fav.station_id,       // <-- ì´ ê°’ì´ ê¼­ ìˆì–´ì•¼ í•¨
            name: fav.station_name,         // nameìœ¼ë¡œ í†µì¼
            position: [fav.latitude, fav.longitude],
            // location: fav.station_location, // locationì´ ë°±ì—”ë“œì—ì„œ ì˜¤ì§€ ì•Šì„ ê²½ìš° ì‚­ì œ
        }));

        setFavorites(formattedFavorites);
    } catch (error) {
        console.error("ì¦ê²¨ì°¾ê¸° ë¡œë”© ì˜¤ë¥˜:", error);
        setFavorites([]); // ì˜¤ë¥˜ ì‹œ ëª©ë¡ ë¹„ìš°ê¸°
    }
}, [userToken]);


  useEffect(() => {
    if (userToken) {
      fetchUserInfo();
      fetchFavorites();
    } else {
      setUserInfo(null);
      setFavorites([]);
    }
  }, [userToken, fetchUserInfo, fetchFavorites]);

  // âœ… ìµœì´ˆ ë Œë”ë§ ì‹œ ëŒ€ì—¬ì†Œ(station) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const fetchStations = async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/api/stations`);
        const data = await res.json();

        const formatted = data.map(st => ({
          station_id: st.station_id,
          name: st.name,
          location: st.station_location,
          position: [st.lat, st.lng], 
          region : st.region,
        }));

        setStations(formatted);
        // setLoading(false);
      } catch (err) {
        console.error('Station fetch error:', err);
      }
  };

  fetchStations();
}, []); // âœ… ë¹ˆ ë°°ì—´ â†’ ì»´í¬ë„ŒíŠ¸ê°€ ì²˜ìŒ ë Œë”ë§ë  ë•Œ 1íšŒë§Œ ì‹¤í–‰


  // ë¡œê·¸ì¸ ë° íšŒì›ê°€ì… ì²˜ë¦¬
  const handleAuth = async (isSignupMode) => {
    setAuthError('');
    const endpoint = isSignupMode ? '/api/auth/signup' : '/api/auth/login';
    
    // âœ… 1. í•¨ìˆ˜ ìƒë‹¨ì— finalPayload ë³€ìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.
    let finalPayload = loginForm; // ê¸°ë³¸ê°’ì€ loginFormìœ¼ë¡œ ì„¤ì • (ë¡œê·¸ì¸ ëª¨ë“œ)

    if (loginForm.password.length < 6) {
        return setAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }

    if (isSignupMode) {
        // ... (ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ì€ ê·¸ëŒ€ë¡œ) ...
        if (loginForm.password !== loginForm.passwordConfirm) {
            return setAuthError('ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        const finalEmail = `${loginForm.emailPrefix}@${loginForm.emailDomain}`;
        if (!loginForm.emailPrefix || !loginForm.emailDomain || !finalEmail.includes('@')) {
            return setAuthError('ì´ë©”ì¼ ì•„ì´ë””ì™€ ë„ë©”ì¸ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        const phoneRegex = /^\d{10,11}$/;
        if (!phoneRegex.test(loginForm.phonenumber)) {
            return setAuthError('ìœ íš¨í•œ í•¸ë“œí° ë²ˆí˜¸(10~11ìë¦¬ ìˆ«ì)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }

        if(loginForm.nickname.trim()< 1 || loginForm.nickname.trim().Length >20){
            return setAuthError('ë‹‰ë„¤ì„ì€ 1ì ì´ìƒ, 20ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        }

        // âœ… 2. íšŒì›ê°€ì… ëª¨ë“œì¼ ë•Œë§Œ finalPayloadë¥¼ êµ¬ì„±ëœ payloadë¡œ ë®ì–´ì”ë‹ˆë‹¤.
        finalPayload = {
            email: finalEmail,
            password: loginForm.password,
            nickname: loginForm.nickname,
            phonenumber: loginForm.phonenumber,
            isTwoFactorEnabled: loginForm.isTwoFactorEnabled,
        };
    } // ğŸ‘ˆ 'finalPayload'ëŠ” if ë¸”ë¡ ë°–ì—ì„œë„ ìœ íš¨í•¨

    try {
        const response = await fetch(BACKEND_URL + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // ğŸš¨ 3. finalPayloadë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            body: JSON.stringify(finalPayload), 
        });

        const data = await response.json();

      if (response.ok) {
        localStorage.setItem('userToken', data.token);
        setUserToken(data.token);
        const initialFormState = { email: '', password: '', passwordConfirm: '', nickname: '', phonenumber: '', emailPrefix: '', emailDomain: 'gmail.com', isTwoFactorEnabled: false }; 
        setLoginForm(initialFormState);
        setIsSignup(false);
        setAuthError(isSignupMode ? 'íšŒì›ê°€ì… ì„±ê³µ!' : 'ë¡œê·¸ì¸ ì„±ê³µ!');
        alert(isSignupMode ? 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        setAuthError(data.error || 'ì¸ì¦ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('Network or API Error:', error);
      setAuthError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Node.js ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }
  };
  

  // ì…ë ¥ í•„ë“œ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;

    setLoginForm(prevForm => ({ 
      ...prevForm,
      [name]: type === 'checkbox' ? checked : value // íƒ€ì…ì— ë”°ë¼ value ë˜ëŠ” checked ì‚¬ìš© 
    }));
    setAuthError('');
  };
  
  // ì†Œì…œ ë¡œê·¸ì¸ ëª©ì—…
  const handleSocialLogin = (providerName) => {
      alert(`ì†Œì…œ ë¡œê·¸ì¸: ${providerName} ì—°ë™ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œ ì„œë²„ì—ì„œ OAuth ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
  };

  const EmailInputFields = ({ loginForm, handleInputChange }) => (
    <div className="email-split-container">
      <input
        type="text"
        name="emailPrefix"
        placeholder="ì´ë©”ì¼ ì•„ì´ë””"
        value={loginForm.emailPrefix}
        onChange={handleInputChange}
        className="login-input"
        style={{ width: '45%', marginRight: '10px' }}
      />
      <span style={{ marginRight: '10px', color: '#555' }}>@</span>
      <input
        type="text"
        name="emailDomain"
        placeholder="gmail.com"
        value={loginForm.emailDomain}
        onChange={handleInputChange}
        className="login-input"
        style={{ width: 'calc(55% - 20px)' }}
      />
    </div>
  )
  // ì¦ê²¨ì°¾ê¸° ì¶”ê°€ í•¨ìˆ˜ (DB ì—°ë™)
  const handleAddFavorite = async (station) => {
  if (!isLoggedIn) {
    alert("ì¦ê²¨ì°¾ê¸°ëŠ” ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/api/favorites`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${userToken}`,
      },
      body: JSON.stringify({ station_id: station.station_id }),
    });

    const data = await res.json();
    if (res.ok) {
      alert("ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì™„ë£Œ!");
      fetchFavorites();
    } else {
      alert(data.error);
    }
  } catch (error) {
    console.error(error);
    alert("ì„œë²„ ì˜¤ë¥˜");
  }
};
//ìœ ì € ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const getCurrentLocation = () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                // ì„±ê³µ ì‹œ, ìœ„ì¹˜ë¥¼ [ìœ„ë„, ê²½ë„] ë°°ì—´ë¡œ ì„¤ì •
                setUserLocation([position.coords.latitude, position.coords.longitude]);
            },
            (error) => {
                console.error("Geolocation Error:", error);
                alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 } // ì˜µì…˜
        );
    } else {
        alert("ë¸Œë¼ìš°ì €ê°€ Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
};
// ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ìœ„ì¹˜ ì •ë³´ ìš”ì²­
useEffect(() => {
    getCurrentLocation();
}, []);

  // ì¦ê²¨ì°¾ê¸° ëª©ë¡ í•­ëª© í´ë¦­ ì‹œ ì§€ë„ ìœ„ì¹˜ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
  const handleGoToFavorite = (position) => {
    setMapCenter(position); 
    setActiveTab('map'); 
  };
  
  // íƒ­ ì „í™˜ í•¸ë“¤ëŸ¬ (í† ê¸€ ë¡œì§ ì ìš©)
  const handleTabToggle = (tabName) => {
      if (activeTab === tabName) {
          setActiveTab('map');
          if (tabName === 'favorites') {
            setIsDeleteMode(false);
        }
      } else {
          setActiveTab(tabName);
      }
  };

const handleCenterButtonClick = () => {
    if (activeTab === 'map') {
        // ì¤‘ì•™ ë²„íŠ¼ì€ ëŒ€ì—¬ì†Œë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ nullì„ ì „ë‹¬ (QR ìŠ¤ìº” ëª¨ë“œ)
        navigateToRentalPage(null); 
    } else {
        setActiveTab('map'); // ë‹¤ë¥¸ íƒ­ì—ì„œëŠ” ì§€ë„ í™”ë©´ìœ¼ë¡œ ë³µê·€
    }
};

  const handleReturnUmbrella = async (stationId, umbrellaId) => {
    if (!stationId || !umbrellaId) {
        alert("ë°˜ë‚©í•  ëŒ€ì—¬ì†Œì™€ ìš°ì‚° ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    if (!window.confirm(`${stationId}ë²ˆ ëŒ€ì—¬ì†Œì— ìš°ì‚°(${umbrellaId})ì„ ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        // 1. ì„œë²„ë¡œ ë°˜ë‚© ìš”ì²­ ì „ì†¡ (POST)
        const res = await fetch(`${BACKEND_URL}/api/rental/return`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${userToken}`, // í† í° í•„ìˆ˜
            },
            body: JSON.stringify({
                station_id: stationId, // ë°±ì—”ë“œê°€ ë°›ëŠ” í‚¤ ì´ë¦„: station_id
                umbrella_id: umbrellaId, // ë°±ì—”ë“œê°€ ë°›ëŠ” í‚¤ ì´ë¦„: umbrella_id
            }),
        });

        const data = await res.json();

        if (res.ok) {
            // 2. ì„±ê³µ ì‹œ ì²˜ë¦¬
            alert("ë°˜ë‚©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            
            // ìƒíƒœ ì´ˆê¸°í™” (ë°˜ë‚© ëª¨ë“œ í•´ì œ)
            setCurrentRentedUmbrellaId(null); 
            setSelectedStationId(null);
            setActiveTab('map'); // ì§€ë„ë¡œ ë³µê·€
            
            // ìµœì‹  ìœ ì € ì •ë³´(ëŒ€ì—¬ ìƒíƒœ ë“±) ê°±ì‹ 
            fetchUserInfo(); 
            
            // ë§Œì•½ í˜„ì¬ ë³´ê³  ìˆëŠ” ëŒ€ì—¬ì†Œì˜ ìš°ì‚° ëª©ë¡ë„ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´:
            // fetchAvailableUmbrella(stationId); 
        } else {
            // 3. ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
            alert(data.error || "ë°˜ë‚© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (error) {
        console.error("Return request error:", error);
        alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
};
  
  const handleRentUmbrella = async (stationId, umbrellaId) => {
    if (!stationId || !umbrellaId) return;

    // ì‚¬ìš©ì í™•ì¸
    if (!window.confirm(`${stationId} ëŒ€ì—¬ì†Œì—ì„œ ìš°ì‚°(${umbrellaId})ì„ ëŒ€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        // 1. ì„œë²„ë¡œ ëŒ€ì—¬ ìš”ì²­ ì „ì†¡ (POST)
        const res = await fetch(`${BACKEND_URL}/api/rental/rent`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}` // ë¡œê·¸ì¸ í† í° í•„ìˆ˜
            },
            body: JSON.stringify({ 
                station_id: stationId, 
                umbrella_id: umbrellaId 
            })
        });

        const data = await res.json();

        if (res.ok) {
            // 2. ì„±ê³µ ì‹œ ì²˜ë¦¬
            alert('ëŒ€ì—¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸ (ëŒ€ì—¬ ì¤‘ ìƒíƒœë¡œ ë³€ê²½)
            setCurrentRentedUmbrellaId(umbrellaId); 
            setSelectedStationId(null);
            setActiveTab('map'); // ì§€ë„ë¡œ ì´ë™
            
            // ìµœì‹  ìœ ì € ì •ë³´(ëŒ€ì—¬ ì •ë³´) ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            fetchUserInfo(); 
        } else {
            // 3. ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
            alert(data.error || 'ëŒ€ì—¬ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Rent request error:', error);
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
};


  // ëŒ€ì—¬ì†Œì˜ ê°€ìš© ìš°ì‚° ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  const fetchAvailableUmbrella = async (stationId) => {

    if (!stationId || !userToken) {
        console.error("âŒ ID ë˜ëŠ” í† í°ì´ ì—†ì–´ì„œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.");
        return;
    }

    try {
        const res = await fetch(`${BACKEND_URL}/api/stations/${stationId}/umbrella`, {
            headers: { Authorization: `Bearer ${userToken}` },
        });
        
        if (res.ok) {
            const data = await res.json();
            setAvailableUmbrella(data);
        } else {
            console.error("âŒ  ì„œë²„ ì‘ë‹µ ì—ëŸ¬ (200 ì•„ë‹˜)");
            setAvailableUmbrella([]);
        }
    } catch (error) {
        console.error('âŒ  ë„¤íŠ¸ì›Œí¬/ì½”ë“œ ì—ëŸ¬ ë°œìƒ:', error);
    }
};
  const navigateToRentalPage = (stationId) => {
   if (!isLoggedIn) {
      handleAuthRedirect(); // ë¡œê·¸ì¸ ì—†ìœ¼ë©´ MY íƒ­ìœ¼ë¡œ ì´ë™
      return;
    }

  setSelectedStationId(stationId);
    
  if (!isReturnMode) {
      // ëŒ€ì—¬ ëª¨ë“œì¼ ê²½ìš°ì—ë§Œ ëª©ë¡ ì¡°íšŒ API í˜¸ì¶œ
      fetchAvailableUmbrella(stationId); 
    }
    
    setActiveTab('rental'); // ë Œíƒˆ í˜ì´ì§€ë¡œ í™”ë©´ ì „í™˜
  };

  //ê²€ìƒ‰ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    const handleSearch = async () => {
        if (!searchTerm.trim()) {
            setSearchResults([]);
            return;
        }

        try {
            // ë°±ì—”ë“œ API í˜¸ì¶œ ì‹œ region ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì „ë‹¬
            const url = `${BACKEND_URL}/api/stations?region=${encodeURIComponent(searchTerm.trim())}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error('ê²€ìƒ‰ ì˜¤ë¥˜ ë°œìƒ');
            }
            
            const data = await res.json();
            
            // station_idì™€ name, ê·¸ë¦¬ê³  ìœ„ì¹˜ ì •ë³´ë§Œ ì¶”ì¶œ
            const formattedResults = data.map(st => ({
                station_id: st.station_id,
                name: st.name,
                position: [st.lat, st.lng],
            }));
            
            setSearchResults(formattedResults);
            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆë‹¤ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì§€ë„ë¥¼ ì´ë™
            if (formattedResults.length > 0) {
                setCenterPosition(formattedResults[0].position);
            }
            
        } catch (err) {
            console.error('Search error:', err);
            setSearchResults([]);
        }
    };
    //ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleResultClick = (station) => {
        setCenterPosition(station.position);
        // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìˆ¨ê¸°ê±°ë‚˜, í•„ìš”í•˜ë‹¤ë©´ ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹«ëŠ” ì¶”ê°€ ë¡œì§ êµ¬í˜„ ê°€ëŠ¥
    };
    // ê·¼ì²˜ ëŒ€ì—¬ì†Œ ì°¾ê¸° useEffect
  useEffect(() => {
      // isNearbySearchActive ìƒíƒœê°€ trueì´ê³ , ì‚¬ìš©ì ìœ„ì¹˜ì™€ ëŒ€ì—¬ì†Œ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
      if (isNearbySearchActive && userLocation && stations.length > 0) {
          const [userLat, userLon] = userLocation;
          
          const nearby = stations
              .map(station => {
                  const [stationLat, stationLon] = station.position;
                  // getDistance í•¨ìˆ˜ëŠ” MapComponent ë°–ì— ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•¨
                  const distance = getDistance(userLat, userLon, stationLat, stationLon); 
                  
                  return { ...station, distance: distance };
              })
              .filter(station => station.distance <= SEARCH_RADIUS)
              .sort((a, b) => a.distance - b.distance); // ê±°ë¦¬ê°€ ê°€ê¹Œìš´ ìˆœìœ¼ë¡œ ì •ë ¬
          
          setNearbyStations(nearby);
      } else if (!isNearbySearchActive) {
          setNearbyStations([]);
      }
  }, [isNearbySearchActive, userLocation, stations, SEARCH_RADIUS]); // ì˜ì¡´ì„± ë°°ì—´ì— isNearbySearchActive ì¶”ê°€

  return (
    <div className="map-container">
      {activeTab === 'map' && (
      <header className="header">
        <div className="search-bar">
          <span className="rental-number" style={{whiteSpace: 'nowrap'}}>ì§€ì—­ê²€ìƒ‰(ë™)</span>
          <input 
              type="text"
              placeholder="ì›í•˜ì‹œëŠ” ì§€ì—­ì´ ì–´ë””ì‹ ê°€ìš”?" 
              value={searchTerm} 
              onChange={(e) => setSearchTerm(e.target.value)} 
              onKeyPress={(e) => { // Enter í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                  }}
                />
                  {/*ê²€ìƒ‰ë²„íŠ¼*/}
                  <button className="search-button" onClick={handleSearch}>ê²€ìƒ‰</button>
        <button 
          onClick={handleNearbySearch}
            style={{
            backgroundColor: isNearbySearchActive ? '#dc3545' : '#17a2b8', // í™œì„±í™”/ë¹„í™œì„±í™” ì‹œ ìƒ‰ìƒ ë³€ê²½
            marginLeft: '5px',
            color: 'white'
            }}
            >
            {isNearbySearchActive ? 'ê²€ìƒ‰ ì¢…ë£Œ' : 'ê·¼ì²˜ ëŒ€ì—¬ì†Œ'}
        </button>

        </div>
      </header>)}

      {/*ê²€ìƒ‰ê²°ê³¼ */}
      {activeTab === 'map' && searchResults.length > 0 && (
          <div className="search-results-list">
              <h3>ì§€ì—­ ê²€ìƒ‰ ê²°ê³¼ ({searchResults.length}ê±´)</h3>
              <ul>
                  {searchResults.map(station => (
                      <li 
                          key={station.station_id} 
                          onClick={() => handleResultClick(station)} // í´ë¦­ ì‹œ ì§€ë„ ì´ë™
                          style={{ cursor: 'pointer', padding: '8px 0', borderBottom: '1px solid #eee' }}
                      >
                        {station.name}
                      </li>
                  ))}
              </ul>
          </div>
      )}

      {/* activeTab ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */}
      {activeTab === 'map' && (
        <MapContainer
          center={mapCenter}
          zoom={15}
          scrollWheelZoom={false}
          className="map"
        >
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />
          {/* ê²€ìƒ‰ í›„ ì§€ë„ì´ë™ */}
          <MapSearchCenterer position={centerPosition} />

          {/* ìœ ì € ìœ„ì¹˜ ë§ˆì»¤ */}
          {userLocation && (
              <Marker position={userLocation} icon={new L.divIcon({ 
                  className: 'user-location-icon', // ìœ„ì—ì„œ ì •ì˜í•œ CSS í´ë˜ìŠ¤
                  html: '<i class="fa fa-user"></i>', // Font Awesome ì•„ì´ì½˜ì„ HTMLë¡œ ì‚½ì… (FaUser ì•„ì´ì½˜ì˜ CSS í´ë˜ìŠ¤ì— ë§ê²Œ ì¡°ì • í•„ìš”)
                  iconAnchor: [15, 15], // ë§ˆì»¤ ì¤‘ì‹¬ì„ ì•„ì´ì½˜ ì¤‘ì•™ì— ë§ì¶¤ (30px/2)
                  popupAnchor: [0, -15], // íŒì—… ìœ„ì¹˜ ì¡°ì • (30px/2)
              })}>
                  <Popup>
                      <b>í˜„ì¬ ë‚´ ìœ„ì¹˜</b>
                      <br />
                      <FaUser style={{ verticalAlign: 'middle', marginRight: '5px' }} />
                  </Popup>
              </Marker>
          )}
          {/* ê·¼ì²˜ ëŒ€ì—¬ì†Œ ì°¾ëŠ” ë¡œì§ */}
          {isNearbySearchActive && userLocation && nearbyStations.length > 0 && (
            <div className="nearby-stations-list" style={{ padding: '15px', background: '#fff', borderTop: '1px solid #ddd', zIndex: 1000, position: 'relative' }}>
                <h3>â­ ê·¼ì²˜ ëŒ€ì—¬ì†Œ ({SEARCH_RADIUS}km ì´ë‚´ {nearbyStations.length}ê°œ)</h3>
                <ul>
                    {nearbyStations.map(station => (
                        <li 
                            key={station.station_id} 
                            // í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ í›„, ê·¼ì²˜ ì°¾ê¸° ëª¨ë“œ ì¢…ë£Œ
                            onClick={() => { 
                                setCenterPosition(station.position);
                                setIsNearbySearchActive(false); 
                            }} 
                            style={{ cursor: 'pointer', marginBottom: '5px', listStyle: 'none' }}
                        >
                            **{station.name}** ({station.distance.toFixed(2)} km)
                        </li>
                    ))}
                </ul>
            </div>
        )}
          {/* userLocationì´ ìˆì§€ë§Œ ëŒ€ì—¬ì†Œê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ ì¶”ê°€ */}
          {isNearbySearchActive && userLocation && nearbyStations.length === 0 && (
              <div style={{ padding: '15px', background: '#fff', borderTop: '1px solid #ddd', zIndex: 1000, position: 'relative', color: '#dc3545' }}>
                  <p>âš ï¸ {SEARCH_RADIUS}km ì´ë‚´ì— ëŒ€ì—¬ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
          )}
          {stations.map((station) => (
            <Marker key={station.station_id} position={station.position}>
              <Popup>
                  {station.name}
                  <br></br>
                  {station.location}  
                  <br />
                  <button onClick={() => handleAddFavorite(station)}>
                      ì¦ê²¨ì°¾ê¸° ì¶”ê°€
                  </button>

                  {/* ëŒ€ì—¬/ë°˜ë‚© ë²„íŠ¼ */}
                  <button
                      onClick={() => navigateToRentalPage(station.station_id)}
                      style={{
                          marginTop: '5px',
                          background: isReturnMode ? '#dc3545' : '#28a745',
                          color: 'white'
                      }}
                  >
                      {isReturnMode ? 'ë°˜ë‚©í•˜ê¸°' : 'ëŒ€ì—¬/ëª©ë¡ ë³´ê¸°'}
                  </button>
                </Popup>
              </Marker>
))}

        </MapContainer>
      )}

      {activeTab === 'my' && (
        <div className='my-page'>
          <h2>ë§ˆì´ í˜ì´ì§€</h2>
          
          <div className='my-list-item' onClick={() => { 
                if (isLoggedIn) handleLogout();
                else setIsSignup(!isSignup);
            }}>
            <FaUser className='my-icon'/>
            <span>{isLoggedIn ? 'ë¡œê·¸ì•„ì›ƒ' : (isSignup ? 'ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'ë¡œê·¸ì¸ / íšŒì›ê°€ì…')}</span>
          </div>

          {isLoggedIn ? (
            // --- ë¡œê·¸ì¸ ìƒíƒœ ---
            <div className="login-status-box logged-in">
              <p>ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p><strong>{userInfo?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong> ë‹˜</p>
              <button className="action-button secondary" onClick={handleLogout}>ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          ) : (
            // --- ë¹„ë¡œê·¸ì¸ ìƒíƒœ & í¼ ---
            <div className="login-form-container">
              <h3>{isSignup ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</h3>
              {authError && <p className="auth-error">{authError}</p>}
              {isSignup ? (
                <>
                  
                  <EmailInputFields
                    loginForm={loginForm} 
                    handleInputChange={handleInputChange}
                  />
                  <input 
                    type="password" 
                    name="password" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" 
                    value={loginForm.password} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                  <input 
                    type="password" 
                    name="passwordConfirm" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" 
                    value={loginForm.passwordConfirm} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                  <input
                    type="nickname"
                    name="nickname"
                    placeholder="ë‹‰ë„¤ì„"
                    value={loginForm.nickname}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <input
                    type="tel"
                    name="phonenumber"
                    placeholder="í•¸ë“œí° ë²ˆí˜¸(ìˆ«ìë§Œ ì…ë ¥)"
                    value={loginForm.phonenumber}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <div className="two-factor-check">
                    <input
                      type="checkbox"
                      name="isTwoFactorEnabled"
                      id="twoFactor"
                      checked={loginForm.isTwoFactorEnabled}
                      onChange={handleInputChange}
                    />
                    <lable htmlFor="twoFactor">
                      2ë‹¨ê³„ ì¸ì¦ í™œì„±í™”
                    </lable>
                  </div>
                </>
              ) : (
                <>
                  <input
                    type="email"
                    name="email"
                    placeholder="ì•„ì´ë””"
                    value={loginForm.email}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <input 
                    type="password" 
                    name="password" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸" 
                    value={loginForm.password} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                </>
              )}
              <button 
                className="action-button primary" 
                onClick={() => handleAuth(isSignup)}
              >
                {isSignup ? 'íšŒì›ê°€ì… ì™„ë£Œ' : 'ë¡œê·¸ì¸'}
              </button>
              <button 
                className="action-button secondary" 
                onClick={() => setIsSignup(!isSignup)}
              >
                {isSignup ? 'ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ' : 'íšŒì›ê°€ì…'}
              </button>
              
              <div style={{marginTop: '20px'}}>
                  <button className="action-button social-google" onClick={() => handleSocialLogin('Google')}>
                      <FaGoogle style={{marginRight: '8px'}} /> Google (UI ëª©ì—…)
                  </button>
              </div>
            </div>
          )}
          <p style={{marginTop: '20px', color: '#999', fontSize: '12px', textAlign: 'center'}}>
              * í˜„ì¬ Node.js ì„œë²„(4000í¬íŠ¸)ì™€ ì—°ë™ë©ë‹ˆë‹¤.
          </p>
        </div>
      )}

      {activeTab === 'favorites' && (
        <div className='favorites-page'>
          <div className='favorites-header'>
            <h3>ì¦ê²¨ì°¾ê¸° ëª©ë¡ ({isLoggedIn ? 'DB ì—°ë™' : 'ë¡œê·¸ì¸ í•„ìš”'})</h3>
            {/* ì¦ê²¨ì°¾ê¸° ì°½ì—ì„œ ë‚˜ê°ˆ ì‹œ ì¦ê²¨ì°¾ê¸° ì‚­ì œëª¨ë“œ í’€ë¦¬ê²Œ */}
            <button 
                onClick={() => handleTabToggle('favorites')} 
                style={{ background: 'none', border: 'none', fontSize: '1.5em', cursor: 'pointer', marginLeft: 'auto' }}
            >
                &times; 
            </button>
            <div className="new-list" onClick={toggleDeleteMode}>
                {/* isDeleteMode ìƒíƒœì— ë”°ë¼ ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ë³€ê²½ */}
                {isDeleteMode ? 
                    (<>
                        <FaCheck style={{ color: 'green' }}/> ì‚­ì œ ëª¨ë“œ ì¢…ë£Œ
                    </>) :
                    (<>
                        <FaMinusCircle style={{ color: 'red' }}/> ì¦ê²¨ì°¾ê¸° ì‚­ì œ
                    </>)
                }
            </div>
          </div>
          <div className='favorites-list-container'>
            {favorites.length > 0 ? (
      <ul>
          {favorites.map((station) => (
              // âœ… ê¸°ì¡´ divë¥¼ lië¡œ ë³€ê²½
              <li 
                  key={station.station_id} 
                  className='favorite-item-wrapper'
              >
                  {/* 1. ì¦ê²¨ì°¾ê¸° ì •ë³´ (í´ë¦­ ì‹œ ì§€ë„ ì´ë™) */}
                  {/* isDeleteModeê°€ ì•„ë‹ ë•Œë§Œ í´ë¦­í•˜ì—¬ ì§€ë„ ì´ë™ */}
                  <div 
                      className='favorite-item' 
                      onClick={() => !isDeleteMode && handleGoToFavorite(station.position)}
                      style={{ cursor: isDeleteMode ? 'default' : 'pointer' }}
                  >
                      <div className='item-icon-wrapper'>
                          <FaStar className='item-icon'/>
                      </div>
                      <div className='item-details'>
                          {/* station.nameì´ ì•„ë‹Œ station_nameì„ ì‚¬ìš©í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (DB ì¡°íšŒ ê²°ê³¼ì— ë”°ë¼ ë‹¤ë¦„) */}
                          <span className='item-name'>{station.station_name || station.name}</span> 
                          <div className='item-sub-info'>
                              <FaLock/> {/* ì„ì‹œ ìë¬¼ì‡  ì•„ì´ì½˜ */}
                          </div>
                      </div>
                  </div>
                
                {/* 2. âœ… ìƒˆë¡œ ì¶”ê°€: ì‚­ì œ ëª¨ë“œì¼ ë•Œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ */}
                {isDeleteMode && (
                    <button 
                        className="delete-button" 
                        // ì¦ê²¨ì°¾ê¸° ì‚­ì œ í•¸ë“¤ëŸ¬ ì—°ê²°
                        onClick={() => handleRemoveFavorite(station)} 
                        style={{ background: 'red', color: 'white', border: 'none', padding: '5px 10px', cursor: 'pointer', marginLeft: '10px' }}
                    >
                        ì‚­ì œ
                    </button>
                )}
            </li>
        ))}
    </ul>
) : (
    <p>{isLoggedIn ? 'í˜„ì¬ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì¦ê²¨ì°¾ê¸° ëª©ë¡ì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.'}</p>
)}
          </div>
        </div>
      )}

      {activeTab === 'rental' && (
         <div className='rental-page'>
          <h2>{isReturnMode ? 'ìš°ì‚° ë°˜ë‚©í•˜ê¸°' : 'ìš°ì‚° ëŒ€ì—¬í•˜ê¸°'}</h2>
          
          <p>
            {isReturnMode ? 
              `í˜„ì¬ ëŒ€ì—¬ ì¤‘: ${currentRentedUmbrellaId}` : 
              `ëŒ€ì—¬ì†Œ: ${selectedStationId || 'QR ìŠ¤ìº” ëª¨ë“œ'}`
            }
          </p>
          
          {/* ëª©ë¡ í‘œì‹œ */}
          {!isReturnMode && availableUmbrella.length > 0 && (
            <div style={{marginTop: '20px'}}>
              <h3>ëŒ€ì—¬ ê°€ëŠ¥í•œ ìš°ì‚° ({availableUmbrella.length}ê°œ)</h3>
              <ul style={{listStyle: 'none', padding: 0}}>
                {availableUmbrella.map(umbrella => (
                  <li 
                    key={umbrella.umbrella_id} 
                    style={{padding: '10px', borderBottom: '1px solid #eee', cursor: 'pointer'}}
                  >
                    ìš°ì‚° ID: {umbrella.umbrella_id}
                    <button 
                        onClick={() => handleRentUmbrella(selectedStationId, umbrella.umbrella_id)} 
                        style={{float: 'right', padding: '5px', backgroundColor: '#28a745', color: 'white', border: 'none', borderRadius: '5px'}}
                    >
                        ëŒ€ì—¬ ì„ íƒ
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          {/* ë°˜ë‚© ë²„íŠ¼ (ë°˜ë‚© ëª¨ë“œ ì‹œ í™œì„±í™”) */}
          {isReturnMode && (
            <button 
              className="action-button primary" 
              onClick={() => handleReturnUmbrella(selectedStationId, currentRentedUmbrellaId)} 
              style={{marginTop: '30px', backgroundColor: '#dc3545'}}
            >
               ìš°ì‚° ë°˜ë‚© ì‹¤í–‰ ({currentRentedUmbrellaId})
             </button>
          )}

          {/* ëŒ€ì—¬ ê°€ëŠ¥ ìš°ì‚°ì´ ì—†ì„ ë•Œ */}
          {!isReturnMode && availableUmbrella.length === 0 && (
            <p style={{color: 'red', marginTop: '20px'}}>í˜„ì¬ ì´ ëŒ€ì—¬ì†Œì— ëŒ€ì—¬ ê°€ëŠ¥í•œ ìš°ì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          )}
        </div>
       )}

      <footer className="footer">
        {/* í•˜ë‹¨ ë²„íŠ¼ 4ê°œ (ì¤‘ì•™ ë²„íŠ¼ ìë¦¬ ë¹„ì›€) */}
        <div className="nav-buttons">
          {/* 1. MY ë²„íŠ¼ */}
          <button className="nav-button" onClick={() => handleTabToggle('my')}>MY</button>
          
          {/* 2. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>

          {/* 3. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>
          
          {/* 4. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>

          {/* 5. ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ */}
          <button className="nav-button" onClick={() => handleTabToggle('favorites')}>ì¦ê²¨ì°¾ê¸°</button>
        </div>
      </footer>
      
      {/* âœ… ì¤‘ì•™ ê³ ì • ë²„íŠ¼ (Footer ë°–, map-container ì•ˆì— ìœ„ì¹˜) */}
      <div className="center-button-wrapper">
          <button 
            className="center-round-button" 
            onClick={handleCenterButtonClick}
          >
            {activeTab === 'map' ? (
                <FaQrcode style={{fontSize: '32px', color: '#fff'}} />
            ) : (
                <FaHome style={{fontSize: '32px', color: '#fff'}} />
            )}
          </button>
      </div>
    </div>
  );
};

export default MapComponent; í”„ë¡ íŠ¸ì—”ë“œ

// server.js

// 1. í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
require('dotenv').config();

// 2. íŒ¨í‚¤ì§€ ë¡œë“œ
const express = require('express');
const mysql = require('mysql2');
const app = express();
const port = 4000;
const cors = require('cors');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

// âœ… JSON íŒŒì‹±
app.use(express.json());

app.use(cors({
    origin: 'http://localhost:3000',
    credentials: true
}));

// âœ… MySQL Pool
const db = mysql.createPool({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_DATABASE,
    port: process.env.DB_PORT,
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0
});

// âœ… ì—°ê²° í…ŒìŠ¤íŠ¸
db.getConnection((err, conn) => {
    if (err) {
        console.error('MySQL ì—°ê²° ì‹¤íŒ¨:', err.message);
        return;
    }
    console.log('âœ… MySQL ì—°ê²° ì„±ê³µ!');
    conn.release();
});

app.get('/', (req, res) => {
    res.send('API Server is running.');
});


// âœ… JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´
const authenticateToken = (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];


    if (!token) {
        return res.status(401).json({ error: 'ì¸ì¦ í† í°ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }
    jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
        if (err) {
            return res.status(403).json({ error: 'í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' });
        }

        req.userId = user.id; // âœ… user_idê°€ ë“¤ì–´ìˆìŒ
        next();
    });
};


// âœ… íšŒì›ê°€ì… ë¼ìš°íŠ¸
app.post('/api/auth/signup', (req, res) => {
    const { email, password, phonenumber, nickname } = req.body;

    if (!email || !password) {
        return res.status(400).json({ error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' });
    }

    bcrypt.hash(password, 10, (err, hashedPassword) => {
        if (err) {
            console.error('Hash Error:', err);
            return res.status(500).json({ error: 'ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ì˜¤ë¥˜' });
        }

        const insertQuery = `
            INSERT INTO user (user_id, password, nickname, phonenumber, email)
            VALUES (?, ?, ?, ?, ?)
        `;

        db.query(insertQuery, [email, hashedPassword, nickname, phonenumber, email], (err) => {
            if (err) {
                if (err.errno === 1062) {
                    return res.status(409).json({ error: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.' });
                }
                console.error('Signup DB Error:', err);
                return res.status(500).json({ error: 'íšŒì›ê°€ì… ì¤‘ DB ì˜¤ë¥˜' });
            }

            // âœ… ì‹¤ì œ JWT ìƒì„±
            const token = jwt.sign(
                { id: email }, 
                process.env.JWT_SECRET, 
                { expiresIn: '1h' }
            );

            res.status(201).json({
                message: 'íšŒì›ê°€ì… ì„±ê³µ',
                token: token
            });
        });
    });
});

// âœ… ì¦ê²¨ì°¾ê¸°
app.post('/api/favorites', authenticateToken, (req, res) => {
    const userId = req.userId;   // JWTì—ì„œ ì¶”ì¶œí•œ user_id
    const { station_id } = req.body;

    if (!station_id) {
        return res.status(400).json({ error: "station_idê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const query = `
        INSERT INTO bookmark (user_id, station_id)
        VALUES (?, ?)
    `;

    db.query(query, [userId, station_id], (err) => {
        if (err) {
            if (err.errno === 1062) {
                return res.status(409).json({ error: "ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ëŒ€ì—¬ì†Œì…ë‹ˆë‹¤." });
            }
            console.error("ì¦ê²¨ì°¾ê¸° ì¶”ê°€ DB ì˜¤ë¥˜:", err);
            return res.status(500).json({ error: "ì¦ê²¨ì°¾ê¸° ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" });
        }

        res.json({ message: "ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤." });
    });
});


// âœ… ì¦ê²¨ì°¾ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
app.get('/api/favorites', authenticateToken, (req, res) => {
    const userId = req.userId;

    const query = `
        SELECT 
            b.station_id,
            s.name AS station_name,
            s.lat AS latitude,
            s.lng AS longitude
        FROM bookmark b
        JOIN station s ON b.station_id = s.station_id
        WHERE b.user_id = ?
    `;

    db.query(query, [userId], (err, results) => {
        if (err) {
            console.error("ì¦ê²¨ì°¾ê¸° ì¡°íšŒ ì˜¤ë¥˜:", err);
            return res.status(500).json({ error: "ì¦ê²¨ì°¾ê¸° ì¡°íšŒ ì‹¤íŒ¨" });
        }
        res.json(results);
    });
});

// âœ… ë¡œê·¸ì¸ ë¼ìš°íŠ¸
app.post('/api/auth/login', (req, res) => {
    const { email, password } = req.body;

    if (!email || !password) {
        return res.status(400).json({ error: 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' });
    }

    const query = `
        SELECT user_id, password
        FROM user
        WHERE user_id = ?
    `;

    db.query(query, [email], async (err, results) => {
        if (err) {
            console.error('Login DB Error:', err.message);
            return res.status(500).json({ error: 'ë¡œê·¸ì¸ DB ì˜¤ë¥˜' });
        }

        if (results.length === 0) {
            return res.status(401).json({ error: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.' });
        }

        const user = results[0];

        // âœ… ë¹„ë°€ë²ˆí˜¸ ë¹„êµ
        const isMatch = await bcrypt.compare(password, user.password);

        if (!isMatch) {
            return res.status(401).json({ error: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
        }

        // âœ… ì •ìƒ JWT ë°œê¸‰ (user.user_id ì‚¬ìš©)
        const token = jwt.sign(
            { id: user.user_id }, 
            process.env.JWT_SECRET,
            { expiresIn: '1h' }
        );

        res.json({
            message: 'ë¡œê·¸ì¸ ì„±ê³µ',
            token: token
        });
    });
});


// âœ… ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
app.get('/api/user', authenticateToken, (req, res) => {
    const userId = req.userId;

    const query = `
        SELECT 
            u.email, 
            u.nickname, 
            u.phonenumber,
            -- âœ… ëŒ€ì—¬ ì¤‘ì¸ ìš°ì‚° IDë¥¼ ì¡°íšŒí•˜ì—¬ current_rental_idë¡œ ë°˜í™˜
            (SELECT umbrella_id FROM umbrella_rental_service 
             WHERE user_id = u.user_id AND return_time IS NULL 
             ORDER BY rent_time DESC LIMIT 1) AS current_rental_id
        FROM user u
        WHERE u.user_id = ?
    `;

    db.query(query, [userId], (err, results) => {
        if (err) {
            console.error('User Fetch Error:', err);
            return res.status(500).json({ error: 'ì‚¬ìš©ì ì¡°íšŒ ì˜¤ë¥˜' });
        }

        if (results.length === 0) {
            return res.status(404).json({ error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
        }

        const user = results[0];

        res.json({
            email: user.email,
            nickname: user.nickname || 'ìµëª… ì‚¬ìš©ì',
            phonenumber: user.phonenumber,
            current_rental_id: user.current_rental_id
        });
    });
});


// âœ… ëŒ€ì—¬ì†Œ ì¡°íšŒ
app.get('/api/stations', (req, res) => {
    const region = req.query.region; // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ region ê°’ì„ ì¶”ì¶œ
    
    let query = 'SELECT * FROM station';
    let params = [];

    // region ê°’ì´ ìˆì„ ê²½ìš° WHERE ì ˆ ì¶”ê°€
    if (region) {
        //  ì¼ì¹˜í•˜ëŠ” ì§€ì—­ì„ ì°¾ìŠµë‹ˆë‹¤.
        query += ' WHERE region = ?';
        params.push(region);
    }
    
    // âœ… ì¿¼ë¦¬ ì‹¤í–‰
    db.query(query, params, (err, results) => {
        if (err) {
            console.error('Station Fetch DB Error:', err); 
            return res.status(500).json({ error: 'DB ì¡°íšŒ ì˜¤ë¥˜' });
        }
         res.json(results);
    });
});

// âœ… ì¦ê²¨ì°¾ê¸° ì‚­ì œ (DELETE)
app.delete('/api/favorites', authenticateToken, (req, res) => {
    const userId = req.userId; // JWTì—ì„œ ì¶”ì¶œí•œ user_id
    // DELETE ìš”ì²­ì€ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ì´ìš©í•´ì„œ
    const station_id = req.query.station_id ? req.query.station_id.trim() : null;
    // 1. station_id ëˆ„ë½ ì—¬ë¶€ í™•ì¸ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜ ë°©ì§€)
    if (!station_id) {
        return res.status(400).json({ error: "station_idê°€ í•„ìš”í•©ë‹ˆë‹¤." });
    }

    const deleteQuery = `
        DELETE FROM bookmark 
        WHERE user_id = ? AND station_id = ?
    `;

    // 2. DB ì‚­ì œ ì¿¼ë¦¬ ì‹¤í–‰
    db.query(deleteQuery, [userId, station_id], (err, result) => {
        if (err) {
            console.error("ì¦ê²¨ì°¾ê¸° ì‚­ì œ DB ì˜¤ë¥˜:", err);
            return res.status(500).json({ error: "ì¦ê²¨ì°¾ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" });
        }

        // 3. ì‚­ì œ ê²°ê³¼ í™•ì¸
        if (result.affectedRows === 0) {
            // ì‚­ì œí•  í•­ëª©ì´ ì—†ëŠ” ê²½ìš°
            return res.status(404).json({ error: "í•´ë‹¹ ì¦ê²¨ì°¾ê¸° í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
        }

        // 4. ì„±ê³µ ì‘ë‹µ
        res.json({ message: "ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });

        
    });
});
// âœ… ìš°ì‚° ëŒ€ì—¬ ë¼ìš°íŠ¸
app.post('/api/rental/rent', authenticateToken, async (req, res) => { // 1. async ì¶”ê°€
    const userId = req.userId;
    const { station_id, umbrella_id } = req.body;

    if (!station_id || !umbrella_id) {
        return res.status(400).json({ error: 'ëŒ€ì—¬ì†Œ IDì™€ ìš°ì‚° IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    let connection; // ì—°ê²° ê°ì²´ë¥¼ ë°–ì— ì„ ì–¸

    try {
        // 2. ì½œë°± ì—†ì´ awaitë¡œ ì—°ê²° ê°€ì ¸ì˜¤ê¸° (ì—¬ê¸°ê°€ í•µì‹¬!)
        connection = await db.promise().getConnection(); 

        // 3. íŠ¸ëœì­ì…˜ ì‹œì‘ (ì½œë°± ì—†ìŒ, awaitë¡œ ëŒ€ê¸°)
        await connection.beginTransaction();

        // ---------------- ë¡œì§ ì‹œì‘ ----------------
        
        // 4. ìš°ì‚° ìƒíƒœ í™•ì¸
        // (ì´ë¯¸ connectionì´ promise ìš©ì´ë¯€ë¡œ .promise() ì•ˆ ë¶™ì—¬ë„ ë¨, í•˜ì§€ë§Œ ë¶™ì—¬ë„ ìƒê´€ì—†ìŒ)
        const [checkResults] = await connection.query(
            `SELECT status, station_id FROM umbrella WHERE umbrella_id = ? FOR UPDATE`, 
            [umbrella_id]
        );

        if (checkResults.length === 0) {
            throw new Error('ìš°ì‚°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const currentStatus = checkResults[0].status;

        if (currentStatus !== 'available') {
            throw new Error('ì´ë¯¸ ëŒ€ì—¬ ì¤‘ì´ê±°ë‚˜ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ìš°ì‚°ì…ë‹ˆë‹¤.');
        }
        
        // 5. ìš°ì‚° ì •ë³´ ì—…ë°ì´íŠ¸
        const updateUmbrellaQuery = `
            UPDATE umbrella
            SET status = 'rented', station_id = NULL, last_user_id = ?
            WHERE umbrella_id = ? AND station_id = ?
        `;
        const [updateResult] = await connection.query(
            updateUmbrellaQuery, 
            [userId, umbrella_id, station_id]
        );

        if (updateResult.affectedRows === 0) {
            throw new Error('ìš°ì‚° ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ ëŒ€ì—¬ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // 6. ëŒ€ì—¬ ì´ë ¥ ì¶”ê°€
        // (rent_idëŠ” AUTO_INCREMENTì´ë¯€ë¡œ ì»¬ëŸ¼ ëª…ì‹œì—ì„œ ì œì™¸)
        const insertHistoryQuery = `
            INSERT INTO umbrella_rental_service 
            (user_id, station_id, umbrella_id, rent_time, return_time)
            VALUES (?, ?, ?, NOW(), NULL)
        `;
        await connection.query(
            insertHistoryQuery, 
            [userId, station_id, umbrella_id]
        );

        // ---------------- ë¡œì§ ë ----------------

        // 7. ì»¤ë°‹ (await ì‚¬ìš© ê°€ëŠ¥)
        await connection.commit();
        
        res.json({ message: 'ìš°ì‚° ëŒ€ì—¬ ì„±ê³µ' });

    } catch (error) {
        // 8. ë¡¤ë°± ë° ì—ëŸ¬ ì²˜ë¦¬
        if (connection) {
            await connection.rollback();
        }
        console.error('Rent Transaction Error:', error.message);
        res.status(400).json({ error: error.message });
    } finally {
        // 9. ì—°ê²° í•´ì œ
        if (connection) connection.release();
    }
});

// âœ… ëŒ€ì—¬ì†Œë³„ ëŒ€ì—¬ ê°€ëŠ¥í•œ ìš°ì‚° ì¡°íšŒ ë¼ìš°íŠ¸
app.get('/api/stations/:station_id/umbrella', authenticateToken, (req, res) => {
    const { station_id } = req.params; // âœ… URLì—ì„œ station_id ì¶”ì¶œ

    console.log(`ğŸ” [ìš”ì²­ í™•ì¸] Station ID: '${station_id}'`);

    const query = `
        SELECT 
            umbrella_id, 
            status, 
            last_user_id 
        FROM umbrella 
        WHERE station_id = ? AND status = 'available'
    `;

    db.query(query, [station_id], (err, results) => {
        if (err) {
            console.error('Available Umbrella Fetch DB Error:', err); 
            return res.status(500).json({ error: 'DB ì¡°íšŒ ì˜¤ë¥˜' });
        }

        console.log(`âœ… [DB ê²°ê³¼] ì¡°íšŒëœ ìš°ì‚° ê°œìˆ˜: ${results.length}ê°œ`);
        res.json(results); // ğŸ‘ˆğŸš¨ ì‘ë‹µ ì „ì†¡ ë¼ì¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    });
});

   app.post('/api/rental/return', authenticateToken, async (req, res) => {
    const userId = req.userId;
    const { station_id, umbrella_id } = req.body;

    console.log(`[ë°˜ë‚© ìš”ì²­] User: ${userId}, Station: ${station_id}, Umbrella: ${umbrella_id}`);

    if (!station_id || !umbrella_id) {
        return res.status(400).json({ error: 'ë°˜ë‚©í•  ëŒ€ì—¬ì†Œ IDì™€ ìš°ì‚° IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    let connection;

    try {
        // 1. Promise ê¸°ë°˜ ì—°ê²° ê°€ì ¸ì˜¤ê¸° (í•µì‹¬ ìˆ˜ì • ì‚¬í•­)
        connection = await db.promise().getConnection();

        // 2. íŠ¸ëœì­ì…˜ ì‹œì‘
        await connection.beginTransaction();

        // ---------------- ë¡œì§ ì‹œì‘ ----------------

        // 3. ëŒ€ì—¬ ì´ë ¥(History) í™•ì¸
        // ê°€ì¥ ìµœê·¼ì— ë¹Œë¦°(ì•„ì§ ë°˜ë‚© ì•ˆ ëœ) ê¸°ë¡ ì°¾ê¸°
        const [rentalCheck] = await connection.query(
            `SELECT rent_id, user_id 
             FROM umbrella_rental_service 
             WHERE umbrella_id = ? AND return_time IS NULL 
             ORDER BY rent_time DESC LIMIT 1 FOR UPDATE`,
            [umbrella_id]
        );

        let rentId = null;

        if (rentalCheck.length > 0) {
            // âœ… ì •ìƒ ì¼€ì´ìŠ¤: ëŒ€ì—¬ ê¸°ë¡ì´ ì¡´ì¬í•¨
            const rentalRecord = rentalCheck[0];
            rentId = rentalRecord.rent_id;

            // 4. ì´ë ¥ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë°˜ë‚© ì‹œê°„, ë°˜ë‚© ì¥ì†Œ ê¸°ë¡)
            await connection.query(
                `UPDATE umbrella_rental_service
                 SET return_time = NOW(), station_id = ? 
                 WHERE rent_id = ?`, 
                [station_id, rentId]
            );
        } else {
            // âš ï¸ ì˜ˆì™¸ ì¼€ì´ìŠ¤: ì´ë ¥ í…Œì´ë¸”ì—ëŠ” ì—†ëŠ”ë° ë°˜ë‚© ìš”ì²­ì´ ì˜´
            console.log("âš ï¸ ëŒ€ì—¬ ê¸°ë¡ ì—†ìŒ. ìš°ì‚° ìƒíƒœ ì§ì ‘ í™•ì¸ í›„ ê°•ì œ ë°˜ë‚© ì‹œë„...");
        }

        // 5. ìš°ì‚° í…Œì´ë¸”(Umbrella) ìƒíƒœ í™•ì¸
        const [umbrellaCheck] = await connection.query(
            `SELECT status FROM umbrella WHERE umbrella_id = ? FOR UPDATE`,
            [umbrella_id]
        );

        if (umbrellaCheck.length === 0) {
            throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìš°ì‚° IDì…ë‹ˆë‹¤.');
        }

        const currentStatus = umbrellaCheck[0].status;

        // ì´ë¯¸ ë°˜ë‚©ëœ ìƒíƒœë¼ë©´ ì—ëŸ¬ ì²˜ë¦¬ (ë‹¨, ëŒ€ì—¬ ê¸°ë¡ ì—…ë°ì´íŠ¸ê°€ ìˆì—ˆìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼)
        if (currentStatus === 'available' && !rentId) {
            throw new Error('ì´ë¯¸ ë°˜ë‚© ì²˜ë¦¬ê°€ ì™„ë£Œëœ ìš°ì‚°ì…ë‹ˆë‹¤.');
        }

        // 6. ìš°ì‚° í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ìƒíƒœ availableë¡œ ë³€ê²½, ìœ„ì¹˜ ë³€ê²½)
        const updateUmbrellaQuery = `
            UPDATE umbrella
            SET status = 'available', station_id = ?
            WHERE umbrella_id = ?
        `;
        await connection.query(
            updateUmbrellaQuery, 
            [station_id, umbrella_id]
        );

        // ---------------- ë¡œì§ ë ----------------

        // 7. ì»¤ë°‹
        await connection.commit();

        console.log(`[ë°˜ë‚© ì™„ë£Œ] ìš°ì‚° ${umbrella_id} ë°˜ë‚© ì„±ê³µ`);
        res.json({ message: 'ìš°ì‚° ë°˜ë‚© ì„±ê³µ' });

    } catch (error) {
        // 8. ë¡¤ë°±
        if (connection) {
            await connection.rollback();
        }
        console.error('[ë°˜ë‚© ì—ëŸ¬]', error.message);
        res.status(400).json({ error: error.message });
    } finally {
        // 9. ì—°ê²° í•´ì œ
        if (connection) connection.release();
    }
});

// âœ… ì„œë²„ ì‹¤í–‰
app.listen(port, () => {
    console.log(`ğŸš€ ì„œë²„ê°€ http://localhost:${port} ì—ì„œ ì‹¤í–‰ ì¤‘`);
});
ë°±ì—”ë“œ
