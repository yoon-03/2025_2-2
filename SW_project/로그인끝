import React, { useState, useEffect } from 'react';
import './App.css'; 
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css'; 
import L from 'leaflet';
import icon from 'leaflet/dist/images/marker-icon.png';
import iconShadow from 'leaflet/dist/images/marker-shadow.png';

import { FaPlus, FaStar, FaLock, FaUser, FaGoogle, FaHome, FaQrcode } from 'react-icons/fa'; 

// --- ë°±ì—”ë“œ ì„¤ì • ---
const BACKEND_URL = 'http://localhost:4000';
// -----------------

let DefaultIcon = L.icon({
  iconUrl: icon,
  shadowUrl: iconShadow,
});
L.Marker.prototype.options.icon = DefaultIcon;

// ì˜ˆì‹œ ëŒ€ì—¬ì†Œ ë°ì´í„°
const stations = [
  { name: 'ë¯¸ì¶”í™€êµ¬ ëŒ€ì—¬ì†Œ', position: [37.45, 126.65] },
  { name: 'ê°•ë‚¨ì—­ ëŒ€ì—¬ì†Œ', position: [37.498, 127.02] },
  { name: 'ì‹ ë„ë¦¼ì—­ ëŒ€ì—¬ì†Œ', position: [37.508, 126.88] },
];

const MapComponent = () => {
  // ì§€ë„ ë° íƒ­ ìƒíƒœ
  const [mapCenter, setMapCenter] = useState(stations[0].position);
  const [activeTab, setActiveTab] = useState('map');
  const [favorites, setFavorites] = useState([]);

  // --- JWT ì¸ì¦ ìƒíƒœ ---
  const [userToken, setUserToken] = useState(localStorage.getItem('userToken'));
  const [userInfo, setUserInfo] = useState(null); 
  const isLoggedIn = !!userToken;
  
  // ì¸ì¦ í¼ ìƒíƒœ
  const [isSignup, setIsSignup] = useState(false); 
  const [loginForm, setLoginForm] = useState({ 
    email: '',
    password: '',
    nickname: '',
    passwordConfirm: '',
    phonenumber: '',
    emailPrefix: '',
    emailDomain: 'gmail.com',
    isTwoFactorEnabled: false
  });
  const [authError, setAuthError] = useState('');
  
  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ë° í† í° ë³€ê²½ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ì¦ê²¨ì°¾ê¸° ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    if (userToken) {
      fetchUserInfo();
      fetchFavorites();
    } else {
      setUserInfo(null);
      setFavorites([]);
    }
  }, [userToken]);

  // --- API í†µì‹  í•¨ìˆ˜ ---

  // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const fetchUserInfo = async () => {
    try {
      const response = await fetch(`${BACKEND_URL}/api/user`, {
        headers: { 'Authorization': `Bearer ${userToken}` },
      });
      if (response.ok) {
        const data = await response.json();
        setUserInfo(data);
      } else {
        handleLogout(); // í† í° ë§Œë£Œ ë“± ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì•„ì›ƒ
      }
    } catch (error) {
      console.error('Failed to fetch user info:', error);
      handleLogout();
    }
  };

  // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const fetchFavorites = async () => {
      if (!userToken) return;
      try {
        const response = await fetch(`${BACKEND_URL}/api/favorites`, {
          headers: { 'Authorization': `Bearer ${userToken}` },
        });
        if (response.ok) {
          const data = await response.json();
          // DBì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ React state í˜•ì‹ì— ë§ê²Œ ë³€í™˜
          const formattedFavorites = data.map(fav => ({
              name: fav.station_name, 
              position: [fav.latitude, fav.longitude]
          }));
          setFavorites(formattedFavorites);
        } else if (response.status !== 401) {
          console.error('Failed to fetch favorites');
        }
      } catch (error) {
        console.error('Fetch Favorites Error:', error);
      }
  };

  // ë¡œê·¸ì¸ ë° íšŒì›ê°€ì… ì²˜ë¦¬
  const handleAuth = async (isSignupMode) => {
    setAuthError('');
    const endpoint = isSignupMode ? '/api/auth/signup' : '/api/auth/login';
    
    // âœ… 1. í•¨ìˆ˜ ìƒë‹¨ì— finalPayload ë³€ìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.
    let finalPayload = loginForm; // ê¸°ë³¸ê°’ì€ loginFormìœ¼ë¡œ ì„¤ì • (ë¡œê·¸ì¸ ëª¨ë“œ)

    if (loginForm.password.length < 6) {
        return setAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }

    if (isSignupMode) {
        // ... (ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ì€ ê·¸ëŒ€ë¡œ) ...
        if (loginForm.password !== loginForm.passwordConfirm) {
            return setAuthError('ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
        const finalEmail = `${loginForm.emailPrefix}@${loginForm.emailDomain}`;
        if (!loginForm.emailPrefix || !loginForm.emailDomain || !finalEmail.includes('@')) {
            return setAuthError('ì´ë©”ì¼ ì•„ì´ë””ì™€ ë„ë©”ì¸ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        const phoneRegex = /^\d{10,11}$/;
        if (!phoneRegex.test(loginForm.phonenumber)) {
            return setAuthError('ìœ íš¨í•œ í•¸ë“œí° ë²ˆí˜¸(10~11ìë¦¬ ìˆ«ì)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }

        if(loginForm.nickname.trim()< 1 || loginForm.nickname.trim().Length >20){
            return setAuthError('ë‹‰ë„¤ì„ì€ 1ì ì´ìƒ, 20ì ì´í•˜ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        }

        // âœ… 2. íšŒì›ê°€ì… ëª¨ë“œì¼ ë•Œë§Œ finalPayloadë¥¼ êµ¬ì„±ëœ payloadë¡œ ë®ì–´ì”ë‹ˆë‹¤.
        finalPayload = {
            email: finalEmail,
            password: loginForm.password,
            nickname: loginForm.nickname,
            phonenumber: loginForm.phonenumber,
            isTwoFactorEnabled: loginForm.isTwoFactorEnabled,
        };
    } // ğŸ‘ˆ 'finalPayload'ëŠ” if ë¸”ë¡ ë°–ì—ì„œë„ ìœ íš¨í•¨

    try {
        const response = await fetch(BACKEND_URL + endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // ğŸš¨ 3. finalPayloadë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            body: JSON.stringify(finalPayload), 
        });

        const data = await response.json();

      if (response.ok) {
        localStorage.setItem('userToken', data.token);
        setUserToken(data.token);
        const initialFormState = { email: '', password: '', passwordConfirm: '', nickname: '', phonenumber: '', emailPrefix: '', emailDomain: 'gmail.com', isTwoFactorEnabled: false }; 
        setLoginForm(initialFormState);
        setIsSignup(false);
        setAuthError(isSignupMode ? 'íšŒì›ê°€ì… ì„±ê³µ!' : 'ë¡œê·¸ì¸ ì„±ê³µ!');
        alert(isSignupMode ? 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        setAuthError(data.error || 'ì¸ì¦ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('Network or API Error:', error);
      setAuthError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Node.js ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }
  };
  
  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
  const handleLogout = () => {
      localStorage.removeItem('userToken');
      setUserToken(null);
      setUserInfo(null);
      setAuthError('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
      alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
  };


  // ì…ë ¥ í•„ë“œ ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;

    setLoginForm(prevForm => ({ 
      ...prevForm,
      [name]: type === 'checkbox' ? checked : value // íƒ€ì…ì— ë”°ë¼ value ë˜ëŠ” checked ì‚¬ìš© 
    }));
    setAuthError('');
  };
  
  // ì†Œì…œ ë¡œê·¸ì¸ ëª©ì—…
  const handleSocialLogin = (providerName) => {
      alert(`ì†Œì…œ ë¡œê·¸ì¸: ${providerName} ì—°ë™ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œ ì„œë²„ì—ì„œ OAuth ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
  };

  const EmailInputFields = ({ loginForm, handleInputChange }) => (
    <div className="email-split-container">
      <input
        type="text"
        name="emailPrefix"
        placeholder="ì´ë©”ì¼ ì•„ì´ë””"
        value={loginForm.emailPrefix}
        onChange={handleInputChange}
        className="login-input"
        style={{ width: '45%', marginRight: '10px' }}
      />
      <span style={{ marginRight: '10px', color: '#555' }}>@</span>
      <input
        type="text"
        name="emailDomain"
        placeholder="gmail.com"
        value={loginForm.emailDomain}
        onChange={handleInputChange}
        className="login-input"
        style={{ width: 'calc(55% - 20px)' }}
      />
    </div>
  )
  // ì¦ê²¨ì°¾ê¸° ì¶”ê°€ í•¨ìˆ˜ (DB ì—°ë™)
  const handleAddFavorite = async (station) => {
    if (!isLoggedIn) {
        alert("ì¦ê²¨ì°¾ê¸° ì¶”ê°€ëŠ” ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/favorites`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify({
                stationName: station.name,
                position: station.position
            }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message);
            fetchFavorites(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            alert(`ì¶”ê°€ ì‹¤íŒ¨: ${data.error}`);
        }
    } catch (error) {
        alert("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ë¡œ ì¦ê²¨ì°¾ê¸°ë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  };

  // ì¦ê²¨ì°¾ê¸° ëª©ë¡ í•­ëª© í´ë¦­ ì‹œ ì§€ë„ ìœ„ì¹˜ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
  const handleGoToFavorite = (position) => {
    setMapCenter(position); 
    setActiveTab('map'); 
  };
  
  // íƒ­ ì „í™˜ í•¸ë“¤ëŸ¬ (í† ê¸€ ë¡œì§ ì ìš©)
  const handleTabToggle = (tabName) => {
      if (activeTab === tabName) {
          setActiveTab('map');
      } else {
          setActiveTab(tabName);
      }
  };


  return (
    <div className="map-container">
      {activeTab === 'map' && (
      <header className="header">
        <div className="search-bar">
          <span className="rental-number" style={{whiteSpace: 'nowrap'}}>ëŒ€ì—¬ì†Œ ë²ˆí˜¸</span>
          <input type="text" placeholder="ì›í•˜ì‹œëŠ” ì§€ì—­ì´ ì–´ë””ì‹ ê°€ìš”?" />
        </div>
      </header>)}

      {/* activeTab ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */}
      {activeTab === 'map' && (
        <MapContainer
          center={mapCenter}
          zoom={15}
          scrollWheelZoom={false}
          className="map"
        >
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />
          {stations.map((station) => (
            <Marker key={station.name} position={station.position}>
              <Popup>
                {station.name}
                <br />
                <button onClick={() => handleAddFavorite(station)}>
                  ì¦ê²¨ì°¾ê¸° ì¶”ê°€ (DB)
                </button>
              </Popup>
            </Marker>
          ))}
        </MapContainer>
      )}

      {activeTab === 'my' && (
        <div className='my-page'>
          <h2>ë§ˆì´ í˜ì´ì§€</h2>
          
          <div className='my-list-item' onClick={() => { 
                if (isLoggedIn) handleLogout();
                else setIsSignup(!isSignup);
            }}>
            <FaUser className='my-icon'/>
            <span>{isLoggedIn ? 'ë¡œê·¸ì•„ì›ƒ' : (isSignup ? 'ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'ë¡œê·¸ì¸ / íšŒì›ê°€ì…')}</span>
          </div>

          {isLoggedIn ? (
            // --- ë¡œê·¸ì¸ ìƒíƒœ ---
            <div className="login-status-box logged-in">
              <p>ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              <p><strong>{userInfo?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong> ë‹˜</p>
              <button className="action-button secondary" onClick={handleLogout}>ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          ) : (
            // --- ë¹„ë¡œê·¸ì¸ ìƒíƒœ & í¼ ---
            <div className="login-form-container">
              <h3>{isSignup ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</h3>
              {authError && <p className="auth-error">{authError}</p>}
              {isSignup ? (
                <>
                  
                  <EmailInputFields
                    loginForm={loginForm} 
                    handleInputChange={handleInputChange}
                  />
                  <input 
                    type="password" 
                    name="password" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" 
                    value={loginForm.password} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                  <input 
                    type="password" 
                    name="passwordConfirm" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" 
                    value={loginForm.passwordConfirm} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                  <input
                    type="nickname"
                    name="nickname"
                    placeholder="ë‹‰ë„¤ì„"
                    value={loginForm.nickname}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <input
                    type="tel"
                    name="phonenumber"
                    placeholder="í•¸ë“œí° ë²ˆí˜¸(ìˆ«ìë§Œ ì…ë ¥)"
                    value={loginForm.phonenumber}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <div className="two-factor-check">
                    <input
                      type="checkbox"
                      name="isTwoFactorEnabled"
                      id="twoFactor"
                      checked={loginForm.isTwoFactorEnabled}
                      onChange={handleInputChange}
                    />
                    <lable htmlFor="twoFactor">
                      2ë‹¨ê³„ ì¸ì¦ í™œì„±í™”
                    </lable>
                  </div>
                </>
              ) : (
                <>
                  <input
                    type="email"
                    name="email"
                    placeholder="ì•„ì´ë””"
                    value={loginForm.email}
                    onChange={handleInputChange}
                    className="login-input"
                  />
                  <input 
                    type="password" 
                    name="password" 
                    placeholder="ë¹„ë°€ë²ˆí˜¸" 
                    value={loginForm.password} 
                    onChange={handleInputChange} 
                    className="login-input"
                  />
                </>
              )}
              <button 
                className="action-button primary" 
                onClick={() => handleAuth(isSignup)}
              >
                {isSignup ? 'íšŒì›ê°€ì… ì™„ë£Œ' : 'ë¡œê·¸ì¸'}
              </button>
              <button 
                className="action-button secondary" 
                onClick={() => setIsSignup(!isSignup)}
              >
                {isSignup ? 'ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ' : 'íšŒì›ê°€ì…'}
              </button>
              
              <div style={{marginTop: '20px'}}>
                  <button className="action-button social-google" onClick={() => handleSocialLogin('Google')}>
                      <FaGoogle style={{marginRight: '8px'}} /> Google (UI ëª©ì—…)
                  </button>
              </div>
            </div>
          )}
          <p style={{marginTop: '20px', color: '#999', fontSize: '12px', textAlign: 'center'}}>
              * í˜„ì¬ Node.js ì„œë²„(4000í¬íŠ¸)ì™€ ì—°ë™ë©ë‹ˆë‹¤.
          </p>
        </div>
      )}

      {activeTab === 'favorites' && (
        <div className='favorites-page'>
          <div className='favorites-header'>
            <h3>ì¦ê²¨ì°¾ê¸° ëª©ë¡ ({isLoggedIn ? 'DB ì—°ë™' : 'ë¡œê·¸ì¸ í•„ìš”'})</h3>
            <div className='new-list'>
              <FaPlus/> ìƒˆ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
            </div>
          </div>
          <div className='favorites-list-container'>
            {favorites.length > 0 ? (
              favorites.map((station) => (
                <div key={station.name} className='favorite-item' onClick={() => handleGoToFavorite(station.position)}>
                  <div className='item-icon-wrapper'>
                    <FaStar className='item-icon'/>
                  </div>
                  <div className='item-details'>
                    <span className='item-name'>{station.name}</span>
                    <div className='item-sub-info'>
                      <FaLock/>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <p>{isLoggedIn ? 'í˜„ì¬ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì¦ê²¨ì°¾ê¸° ëª©ë¡ì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.'}</p>
            )}
          </div>
        </div>
      )}

      <footer className="footer">
        {activeTab === 'map' && (
            <div className="time-display">12 min</div>
        )}
        
        {/* í•˜ë‹¨ ë²„íŠ¼ 4ê°œ (ì¤‘ì•™ ë²„íŠ¼ ìë¦¬ ë¹„ì›€) */}
        <div className="nav-buttons">
          {/* 1. MY ë²„íŠ¼ */}
          <button className="nav-button" onClick={() => handleTabToggle('my')}>MY</button>
          
          {/* 2. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>

          {/* 3. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>
          
          {/* 4. ë¹ˆ ê³µê°„ */}
          <button className="nav-button invisible-button" style={{visibility: 'hidden'}}></button>

          {/* 5. ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ */}
          <button className="nav-button" onClick={() => handleTabToggle('favorites')}>ì¦ê²¨ì°¾ê¸°</button>
        </div>
      </footer>
      
      {/* âœ… ì¤‘ì•™ ê³ ì • ë²„íŠ¼ (Footer ë°–, map-container ì•ˆì— ìœ„ì¹˜) */}
      <div className="center-button-wrapper">
          <button 
            className="center-round-button" 
            onClick={() => setActiveTab('map')}
          >
            {activeTab === 'map' ? (
                <FaQrcode style={{fontSize: '32px', color: '#fff'}} />
            ) : (
                <FaHome style={{fontSize: '32px', color: '#fff'}} />
            )}
          </button>
      </div>
    </div>
  );
};

export default MapComponent;
