//12.13 ìˆ˜ì •ì „ ë°±ì—…
import React, { useState, useEffect, useCallback, useRef } from 'react';
import {
  SafeAreaView, View, Text, TextInput, TouchableOpacity, StyleSheet,
  Alert, ScrollView, PermissionsAndroid, Platform
} from 'react-native';

import AsyncStorage from '@react-native-async-storage/async-storage';
import Icon from 'react-native-vector-icons/FontAwesome';
import Geolocation from 'react-native-geolocation-service';
import { WebView } from 'react-native-webview'; // [ë³€ê²½] ì›¹ë·° ì„í¬íŠ¸

// ==========================================
// ğŸ”‘ [ì¤‘ìš”] ì¹´ì¹´ì˜¤ JavaScript í‚¤ë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”!
const KAKAO_JS_KEY = '56217af959637658938508eb9a24a22c'; 
// ==========================================

const BACKEND_URL = 'http://10.0.2.2:4000';
const EARTH_RADIUS_KM = 6371;

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
const getDistance = (lat1, lon1, lat2, lon2) => {
  const toRad = (value) => (value * Math.PI) / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return EARTH_RADIUS_KM * c;
};

function App() {
  // --- ìƒíƒœ ê´€ë¦¬ ---
  const [stations, setStations] = useState([]);
  
  // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ (ê¸°ë³¸: ì¸í•˜ê³µì „)
  const [centerLocation, setCenterLocation] = useState({
    latitude: 37.4481,
    longitude: 126.657,
  });

  const [activeTab, setActiveTab] = useState('map');
  const [favorites, setFavorites] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [isDeleteMode, setIsDeleteMode] = useState(false);
  const [userLocation, setUserLocation] = useState(null);
  const [nearbyStations, setNearbyStations] = useState([]);
  const [userToken, setUserToken] = useState(null);
  const [userInfo, setUserInfo] = useState(null);
  
  const isLoggedIn = !!userToken;
  const [selectedStationId, setSelectedStationId] = useState(null);
  const [currentRentedUmbrellaId, setCurrentRentedUmbrellaId] = useState(null);
  const isReturnMode = !!currentRentedUmbrellaId;
  const [availableUmbrella, setAvailableUmbrella] = useState([]);
  const [isNearbySearchActive, setIsNearbySearchActive] = useState(false);
  const SEARCH_RADIUS = 2;

  // ì›¹ë·° ì œì–´ìš© Ref
  const webViewRef = useRef(null);

  // ë¡œê·¸ì¸ í¼ ìƒíƒœ
  const [isSignup, setIsSignup] = useState(false);
  const [loginForm, setLoginForm] = useState({
    email: '', password: '', nickname: '', passwordConfirm: '',
    phonenumber: '', emailPrefix: '', emailDomain: 'gmail.com'
  });
  const [authError, setAuthError] = useState('');

  // --- 1. ê¶Œí•œ ë° í† í° ë¡œë“œ ---
  useEffect(() => {
    const checkPermissionsAndToken = async () => {
      if (Platform.OS === 'android') {
        await PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.ACCESS_FINE_LOCATION);
      }
      getCurrentLocation();

      const token = await AsyncStorage.getItem('userToken');
      if (token) setUserToken(token);
    };
    checkPermissionsAndToken();
  }, []);

  // --- 2. ë°ì´í„° í˜ì¹­ ---
  const fetchUserInfo = useCallback(async () => {
    if (!userToken) return;
    try {
      const response = await fetch(`${BACKEND_URL}/api/user`, {
        headers: { 'Authorization': `Bearer ${userToken}` },
      });
      if (response.ok) {
        const data = await response.json();
        setUserInfo(data);
        setCurrentRentedUmbrellaId(data.current_rental_id || null);
      } else {
        handleLogout();
      }
    } catch (error) {
      console.error('User fetch error', error);
    }
  }, [userToken]);

  const fetchFavorites = useCallback(async () => {
    if (!userToken) return;
    try {
      const res = await fetch(`${BACKEND_URL}/api/favorites`, {
        headers: { Authorization: `Bearer ${userToken}` },
      });
      const data = await res.json();
      setFavorites(data);
    } catch (error) {
      console.error("Favorites error", error);
    }
  }, [userToken]);

  useEffect(() => {
    if (userToken) {
      fetchUserInfo();
      fetchFavorites();
    } else {
      setUserInfo(null);
      setFavorites([]);
    }
  }, [userToken, fetchUserInfo, fetchFavorites]);

  // --- 3. ëŒ€ì—¬ì†Œ ëª©ë¡ ë¡œë“œ ---
  useEffect(() => {
    const fetchStations = async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/api/stations`);
        const data = await res.json();
        setStations(data);
      } catch (err) {
        console.error('Station fetch error:', err);
      }
    };
    fetchStations();
  }, []);

  // --- ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ---
  const getCurrentLocation = () => {
    Geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        setUserLocation({ latitude, longitude });
        // ë‚´ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ (ì˜µì…˜)
        // setCenterLocation({ latitude, longitude });
      },
      (error) => {
        console.log(error.code, error.message);
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 }
    );
  };

  // --- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë¡œì§ ---
  const handleAuth = async () => {
    setAuthError('');
    const endpoint = isSignup ? '/api/auth/signup' : '/api/auth/login';
    let finalPayload = { ...loginForm };
    if (isSignup) {
        if (loginForm.password !== loginForm.passwordConfirm) return setAuthError('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');
        finalPayload.email = `${loginForm.emailPrefix}@${loginForm.emailDomain}`;
    }
    try {
      const response = await fetch(`${BACKEND_URL}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(finalPayload),
      });
      const data = await response.json();
      if (response.ok) {
        await AsyncStorage.setItem('userToken', data.token);
        setUserToken(data.token);
        setIsSignup(false);
        Alert.alert('ì„±ê³µ', isSignup ? 'íšŒì›ê°€ì… ì™„ë£Œ' : 'ë¡œê·¸ì¸ ì„±ê³µ');
      } else {
        setAuthError(data.error || 'ì‹¤íŒ¨');
      }
    } catch (error) {
      setAuthError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    }
  };

  const handleLogout = async () => {
    await AsyncStorage.removeItem('userToken');
    setUserToken(null);
    setUserInfo(null);
    setCurrentRentedUmbrellaId(null);
    Alert.alert('ë¡œê·¸ì•„ì›ƒ', 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };

  const handleTabToggle = (tabName) => {
    setActiveTab(prev => (prev === tabName ? 'map' : tabName));
    if(tabName === 'favorites') setIsDeleteMode(false);
  };

  // --- ì§€ë„ ê²€ìƒ‰ ---
  const handleSearch = async () => {
    if (!searchTerm.trim()) return;
    try {
        const res = await fetch(`${BACKEND_URL}/api/stations?region=${encodeURIComponent(searchTerm.trim())}`);
        const data = await res.json();
        if (data.length > 0) {
            setCenterLocation({ latitude: data[0].lat, longitude: data[0].lng });
        } else {
            Alert.alert("ê²€ìƒ‰ ê²°ê³¼", "í•´ë‹¹ ì§€ì—­ì— ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    } catch (e) { console.error(e); }
  };

  // --- ê·¼ì²˜ ëŒ€ì—¬ì†Œ ë¡œì§ ---
  useEffect(() => {
    if (isNearbySearchActive && userLocation && stations.length > 0) {
        const nearby = stations.map(st => {
            const dist = getDistance(userLocation.latitude, userLocation.longitude, st.lat, st.lng);
            return { ...st, distance: dist };
        }).filter(st => st.distance <= SEARCH_RADIUS).sort((a, b) => a.distance - b.distance);
        setNearbyStations(nearby);
    } else {
        setNearbyStations([]);
    }
  }, [isNearbySearchActive, userLocation, stations]);

  // --- ëŒ€ì—¬/ë°˜ë‚© í˜ì´ì§€ ì´ë™ ---
  const navigateToRentalPage = async (stationId) => {
      if (!isLoggedIn) {
          Alert.alert('ì•Œë¦¼', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          setActiveTab('my');
          return;
      }
      setSelectedStationId(stationId);
      if (!isReturnMode && stationId) {
          const res = await fetch(`${BACKEND_URL}/api/stations/${stationId}/umbrella`, {
              headers: { Authorization: `Bearer ${userToken}` }
          });
          const data = await res.json();
          setAvailableUmbrella(data);
      }
      setActiveTab('rental');
  };

  const handleRentUmbrella = async (uId) => {
      Alert.alert('ëŒ€ì—¬ í™•ì¸', `${selectedStationId}ë²ˆ ëŒ€ì—¬ì†Œì—ì„œ ìš°ì‚°(${uId})ì„ ëŒ€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
          { text: 'ì·¨ì†Œ', style: 'cancel'},
          { text: 'ëŒ€ì—¬', onPress: async () => {
              try {
                  const res = await fetch(`${BACKEND_URL}/api/rental/rent`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                      body: JSON.stringify({ station_id: selectedStationId, umbrella_id: uId })
                  });
                  const data = await res.json();
                  if(res.ok) {
                      Alert.alert('ì„±ê³µ', 'ëŒ€ì—¬ ì™„ë£Œ!');
                      setCurrentRentedUmbrellaId(uId);
                      setActiveTab('map');
                      fetchUserInfo();
                  } else {
                      Alert.alert('ì‹¤íŒ¨', data.error);
                  }
              } catch(e) { Alert.alert('ì˜¤ë¥˜', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜'); }
          }}
      ]);
  };

  const handleReturnUmbrella = async () => {
      Alert.alert('ë°˜ë‚© í™•ì¸', `${selectedStationId}ë²ˆ ëŒ€ì—¬ì†Œì— ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
        { text: 'ì·¨ì†Œ', style: 'cancel'},
        { text: 'ë°˜ë‚©', onPress: async () => {
            try {
                const res = await fetch(`${BACKEND_URL}/api/rental/return`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                    body: JSON.stringify({ station_id: selectedStationId, umbrella_id: currentRentedUmbrellaId })
                });
                if(res.ok) {
                    Alert.alert('ì„±ê³µ', 'ë°˜ë‚© ì™„ë£Œ!');
                    setCurrentRentedUmbrellaId(null);
                    setActiveTab('map');
                    fetchUserInfo();
                } else {
                    Alert.alert('ì‹¤íŒ¨', 'ë°˜ë‚© ì‹¤íŒ¨');
                }
            } catch(e) { Alert.alert('ì˜¤ë¥˜', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜'); }
        }}
    ]);
  };

  const handleAddFavorite = async (stationId) => {
    if(!isLoggedIn) return Alert.alert('ì•Œë¦¼', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    try {
        const res = await fetch(`${BACKEND_URL}/api/favorites`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
            body: JSON.stringify({ station_id: stationId })
        });
        if(res.ok) { Alert.alert('ì™„ë£Œ', 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€ë¨'); fetchFavorites(); }
        else Alert.alert('ì‹¤íŒ¨', 'ì´ë¯¸ ì¶”ê°€ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ');
    } catch(e) { console.error(e); }
  };

  // ----------------------------------------------------
  // [í•µì‹¬] ì¹´ì¹´ì˜¤ë§µ HTML ìƒì„± í•¨ìˆ˜
  // ----------------------------------------------------
  const generateMapHtml = () => {
    // stations ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ HTMLì— ì£¼ì…
    const stationsJson = JSON.stringify(stations);
    
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_JS_KEY}&libraries=services"></script>
        <style>
            body { margin: 0; padding: 0; }
            #map { width: 100%; height: 100vh; }
        </style>
      </head>
      <body>
        <div id="map"></div>
        <script>
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(${centerLocation.latitude}, ${centerLocation.longitude}),
                level: 3
            };
            var map = new kakao.maps.Map(container, options);

            // RNì—ì„œ ë°›ì€ ë°ì´í„°
            var stations = ${stationsJson};

            // ë§ˆì»¤ ì´ë¯¸ì§€ (ì›í•˜ëŠ” ì´ë¯¸ì§€ URLë¡œ êµì²´ ê°€ëŠ¥)
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
            var imageSize = new kakao.maps.Size(24, 35); 
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 

            // ë§ˆì»¤ ìƒì„± ë°˜ë³µë¬¸
            stations.forEach(function(station) {
                var markerPosition  = new kakao.maps.LatLng(station.lat, station.lng); 
                var marker = new kakao.maps.Marker({
                    position: markerPosition,
                    title: station.name,
                    image: markerImage
                });
                marker.setMap(map);

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ -> RNìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
                kakao.maps.event.addListener(marker, 'click', function() {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'markerClick',
                        id: station.station_id,
                        name: station.name
                    }));
                });
            });
        </script>
      </body>
      </html>
    `;
  };

  // RNì—ì„œ ì›¹ë·° ë©”ì‹œì§€ ë°›ê¸° (ë§ˆì»¤ í´ë¦­ ì‹œ)
  const handleWebViewMessage = (event) => {
    const data = JSON.parse(event.nativeEvent.data);
    if (data.type === 'markerClick') {
        Alert.alert(data.name, 'ë¬´ì—‡ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
            { text: 'ëŒ€ì—¬/ë°˜ë‚©', onPress: () => navigateToRentalPage(data.id) },
            { text: 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€', onPress: () => handleAddFavorite(data.id) },
            { text: 'ë‹«ê¸°', style: 'cancel' }
        ]);
    }
  };

  return (
    <SafeAreaView style={styles.container}>
      
      {/* --- 1. ë§µ íƒ­ --- */}
      {activeTab === 'map' && (
        <>
          <View style={styles.header}>
            <TextInput 
                style={styles.searchInput} 
                placeholder="ì§€ì—­ ê²€ìƒ‰ (ë™)" 
                value={searchTerm}
                onChangeText={setSearchTerm}
                onSubmitEditing={handleSearch}
            />
            <TouchableOpacity style={styles.searchButton} onPress={handleSearch}>
                <Text style={styles.btnText}>ê²€ìƒ‰</Text>
            </TouchableOpacity>
            <TouchableOpacity 
                style={[styles.nearbyButton, { backgroundColor: isNearbySearchActive ? '#dc3545' : '#17a2b8' }]}
                onPress={() => {
                    setIsNearbySearchActive(!isNearbySearchActive);
                    if(!isNearbySearchActive) getCurrentLocation();
                }}
            >
                <Text style={styles.btnText}>{isNearbySearchActive ? 'ì¢…ë£Œ' : 'ê·¼ì²˜'}</Text>
            </TouchableOpacity>
          </View>
          
          {isNearbySearchActive && nearbyStations.length > 0 && (
              <View style={styles.nearbyList}>
                  <Text style={styles.nearbyTitle}>ê·¼ì²˜ ëŒ€ì—¬ì†Œ ({nearbyStations.length})</Text>
                  <ScrollView style={{maxHeight: 100}}>
                    {nearbyStations.map(st => (
                        <TouchableOpacity key={st.station_id} onPress={() => {
                            setCenterLocation({latitude: st.lat, longitude: st.lng});
                            setIsNearbySearchActive(false);
                        }}>
                            <Text style={{padding: 5}}>{st.name} ({st.distance.toFixed(2)}km)</Text>
                        </TouchableOpacity>
                    ))}
                  </ScrollView>
              </View>
          )}

          {/* [ë³€ê²½] ì¹´ì¹´ì˜¤ë§µ ì›¹ë·° */}
          <WebView
            ref={webViewRef}
            originWhitelist={['*']}
            source={{ html: generateMapHtml() }} // HTML í•¨ìˆ˜ í˜¸ì¶œ
            style={styles.map}
            onMessage={handleWebViewMessage} // JS -> RN í†µì‹ 
            javaScriptEnabled={true}
          />
        </>
      )}

      {/* --- 2. ë§ˆì´ í˜ì´ì§€ --- */}
      {activeTab === 'my' && (
        <View style={styles.pageContainer}>
            <Text style={styles.pageTitle}>ë§ˆì´ í˜ì´ì§€</Text>
            {isLoggedIn ? (
                <View style={styles.centerContent}>
                    <Icon name="user-circle" size={80} color="#333" />
                    <Text style={styles.userName}>{userInfo?.nickname} ë‹˜</Text>
                    <Text>{userInfo?.email}</Text>
                    <TouchableOpacity style={styles.logoutBtn} onPress={handleLogout}>
                        <Text style={styles.whiteText}>ë¡œê·¸ì•„ì›ƒ</Text>
                    </TouchableOpacity>
                </View>
            ) : (
                <ScrollView>
                    <Text style={styles.subTitle}>{isSignup ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</Text>
                    {isSignup && (
                        <>
                         <View style={{flexDirection:'row'}}>
                            <TextInput style={[styles.input, {flex:1}]} placeholder="ì´ë©”ì¼ ID" value={loginForm.emailPrefix} onChangeText={t=>setLoginForm({...loginForm, emailPrefix:t})} />
                            <Text style={{padding:15}}>@</Text>
                            <TextInput style={[styles.input, {flex:1}]} placeholder="ë„ë©”ì¸" value={loginForm.emailDomain} onChangeText={t=>setLoginForm({...loginForm, emailDomain:t})} />
                         </View>
                         <TextInput style={styles.input} placeholder="ë‹‰ë„¤ì„" value={loginForm.nickname} onChangeText={t=>setLoginForm({...loginForm, nickname:t})} />
                         <TextInput style={styles.input} placeholder="íœ´ëŒ€í° ë²ˆí˜¸" keyboardType="numeric" value={loginForm.phonenumber} onChangeText={t=>setLoginForm({...loginForm, phonenumber:t})} />
                        </>
                    )}
                    {!isSignup && (
                        <TextInput style={styles.input} placeholder="ì´ë©”ì¼" value={loginForm.email} onChangeText={t=>setLoginForm({...loginForm, email:t})} />
                    )}
                    <TextInput style={styles.input} placeholder="ë¹„ë°€ë²ˆí˜¸" secureTextEntry value={loginForm.password} onChangeText={t=>setLoginForm({...loginForm, password:t})} />
                    {isSignup && <TextInput style={styles.input} placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" secureTextEntry value={loginForm.passwordConfirm} onChangeText={t=>setLoginForm({...loginForm, passwordConfirm:t})} />}
                    
                    <Text style={{color:'red', marginBottom: 10}}>{authError}</Text>

                    <TouchableOpacity style={styles.primaryBtn} onPress={handleAuth}>
                        <Text style={styles.whiteText}>{isSignup ? 'ê°€ì…ì™„ë£Œ' : 'ë¡œê·¸ì¸'}</Text>
                    </TouchableOpacity>
                    <TouchableOpacity style={styles.secondaryBtn} onPress={() => setIsSignup(!isSignup)}>
                        <Text>{isSignup ? 'ë¡œê·¸ì¸ í•˜ëŸ¬ê°€ê¸°' : 'íšŒì›ê°€ì… í•˜ê¸°'}</Text>
                    </TouchableOpacity>
                </ScrollView>
            )}
        </View>
      )}

      {/* --- 3. ì¦ê²¨ì°¾ê¸° --- */}
      {activeTab === 'favorites' && (
        <View style={styles.pageContainer}>
            <View style={styles.rowBetween}>
                <Text style={styles.pageTitle}>ì¦ê²¨ì°¾ê¸°</Text>
                <TouchableOpacity onPress={() => setIsDeleteMode(!isDeleteMode)}>
                    <Text style={{color: isDeleteMode ? 'green' : 'red'}}>
                        {isDeleteMode ? 'ì™„ë£Œ' : 'ì‚­ì œê´€ë¦¬'}
                    </Text>
                </TouchableOpacity>
            </View>
            <ScrollView>
                {favorites.map(fav => (
                    <View key={fav.station_id} style={styles.listItem}>
                        <TouchableOpacity 
                            style={{flex:1, flexDirection:'row', alignItems:'center'}}
                            onPress={() => {
                                if(!isDeleteMode) {
                                    setCenterLocation({latitude: fav.latitude, longitude: fav.longitude});
                                    setActiveTab('map');
                                }
                            }}
                        >
                            <Icon name="star" size={20} color="#FFD700" />
                            <Text style={{marginLeft: 10, fontSize: 16}}>{fav.station_name}</Text>
                        </TouchableOpacity>
                        {isDeleteMode && (
                            <TouchableOpacity onPress={async () => {
                                await fetch(`${BACKEND_URL}/api/favorites?station_id=${fav.station_id}`, {
                                    method: 'DELETE', headers: { Authorization: `Bearer ${userToken}` }
                                });
                                fetchFavorites();
                            }}>
                                <Icon name="minus-circle" size={24} color="red" />
                            </TouchableOpacity>
                        )}
                    </View>
                ))}
                {favorites.length === 0 && <Text style={{textAlign:'center', marginTop:20}}>ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>}
            </ScrollView>
        </View>
      )}

      {/* --- 4. ë Œíƒˆ í˜ì´ì§€ --- */}
      {activeTab === 'rental' && (
        <View style={styles.pageContainer}>
            <Text style={styles.pageTitle}>{isReturnMode ? 'ìš°ì‚° ë°˜ë‚©' : 'ìš°ì‚° ëŒ€ì—¬'}</Text>
            <Text style={styles.subTitle}>ëŒ€ì—¬ì†Œ ID: {selectedStationId}</Text>
            
            {isReturnMode ? (
                <View style={styles.centerContent}>
                    <Text style={{fontSize:18, marginBottom:20}}>ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</Text>
                    <TouchableOpacity style={[styles.primaryBtn, {backgroundColor: '#dc3545'}]} onPress={handleReturnUmbrella}>
                        <Text style={styles.whiteText}>ë°˜ë‚©í•˜ê¸°</Text>
                    </TouchableOpacity>
                </View>
            ) : (
                <ScrollView>
                    {availableUmbrella.length > 0 ? availableUmbrella.map(umb => (
                        <TouchableOpacity key={umb.umbrella_id} style={styles.listItem} onPress={() => handleRentUmbrella(umb.umbrella_id)}>
                            <Text>ìš°ì‚° ID: {umb.umbrella_id}</Text>
                            <View style={styles.smallBtn}><Text style={styles.whiteText}>ëŒ€ì—¬</Text></View>
                        </TouchableOpacity>
                    )) : <Text style={{textAlign:'center', marginTop:20}}>ëŒ€ì—¬ ê°€ëŠ¥í•œ ìš°ì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</Text>}
                </ScrollView>
            )}
            <TouchableOpacity style={styles.secondaryBtn} onPress={() => setActiveTab('map')}>
                <Text>ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</Text>
            </TouchableOpacity>
        </View>
      )}

      {/* --- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ --- */}
      <View style={styles.navBar}>
        <TouchableOpacity style={styles.navBtn} onPress={() => handleTabToggle('my')}>
            <Icon name="user" size={24} color={activeTab === 'my' ? 'blue' : 'gray'} />
            <Text>MY</Text>
        </TouchableOpacity>
        
        <View style={styles.centerBtnWrapper}>
            <TouchableOpacity style={styles.centerBtn} onPress={() => {
                if(activeTab === 'map') navigateToRentalPage(null); 
                else setActiveTab('map');
            }}>
                <Icon name={activeTab === 'map' ? "qrcode" : "home"} size={30} color="white" />
            </TouchableOpacity>
        </View>

        <TouchableOpacity style={styles.navBtn} onPress={() => handleTabToggle('favorites')}>
            <Icon name="star" size={24} color={activeTab === 'favorites' ? 'blue' : 'gray'} />
            <Text>ì¦ê²¨ì°¾ê¸°</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fff' },
  header: { flexDirection: 'row', padding: 10, alignItems: 'center', backgroundColor: '#f8f9fa' },
  searchInput: { flex: 1, borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 5, backgroundColor: '#fff' },
  searchButton: { marginLeft: 5, padding: 10, backgroundColor: '#007bff', borderRadius: 5 },
  nearbyButton: { marginLeft: 5, padding: 10, borderRadius: 5 },
  btnText: { color: '#fff', fontWeight: 'bold' },
  
  // [ë³€ê²½] ì§€ë„ê°€ ì›¹ë·°ì´ë¯€ë¡œ flex 1 í•„ìˆ˜
  map: { flex: 1 },
  
  nearbyList: { position: 'absolute', top: 60, left: 10, right: 10, backgroundColor: 'white', zIndex: 10, padding: 10, borderRadius: 5, elevation: 5 },
  nearbyTitle: { fontWeight: 'bold', marginBottom: 5 },
  
  navBar: { flexDirection: 'row', height: 60, borderTopWidth: 1, borderColor: '#eee', justifyContent: 'space-between', alignItems: 'center', paddingHorizontal: 30 },
  navBtn: { alignItems: 'center' },
  centerBtnWrapper: { position: 'absolute', left: '50%', top: -20, marginLeft: -30 }, 
  centerBtn: { width: 60, height: 60, borderRadius: 30, backgroundColor: '#007bff', justifyContent: 'center', alignItems: 'center', elevation: 5 },
  
  pageContainer: { flex: 1, padding: 20 },
  pageTitle: { fontSize: 24, fontWeight: 'bold', marginBottom: 20 },
  subTitle: { fontSize: 18, marginBottom: 10 },
  input: { borderWidth: 1, borderColor: '#ddd', padding: 10, marginBottom: 10, borderRadius: 5 },
  primaryBtn: { backgroundColor: '#007bff', padding: 15, borderRadius: 5, alignItems: 'center', marginTop: 10 },
  secondaryBtn: { padding: 15, alignItems: 'center', marginTop: 10 },
  logoutBtn: { backgroundColor: '#dc3545', padding: 10, borderRadius: 5, marginTop: 20 },
  whiteText: { color: '#fff', fontWeight: 'bold' },
  
  centerContent: { alignItems: 'center', justifyContent: 'center', flex: 1 },
  userName: { fontSize: 20, fontWeight: 'bold', marginTop: 10 },
  
  listItem: { flexDirection: 'row', padding: 15, borderBottomWidth: 1, borderColor: '#eee', alignItems: 'center', justifyContent: 'space-between' },
  smallBtn: { backgroundColor: '#28a745', padding: 5, borderRadius: 3 },
  rowBetween: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }
});

export default App;
